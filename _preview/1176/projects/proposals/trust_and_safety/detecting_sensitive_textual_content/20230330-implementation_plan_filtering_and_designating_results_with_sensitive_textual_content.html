<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />
<link rel="index" title="Index" href="../../../../genindex.html" /><link rel="search" title="Search" href="../../../../search.html" /><link rel="next" title="Trust and Safety" href="../index.html" /><link rel="prev" title="2023-03-09 Project Proposal" href="20230309-project_proposal_detecting_sensitive_textual_content.html" />

    <link rel="shortcut icon" href="https://raw.githubusercontent.com/WordPress/openverse/master/brand/icon.svg"/><!-- Generated with Sphinx 6.1.3 and Furo 2023.03.27 -->
        <title>2023-03-30 Implementation Plan: Filtering and designating results with sensitive textual content - Openverse documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/styles/furo.css?digest=fad236701ea90a88636c2a8c73b44ae642ed2a53" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../../index.html"><div class="brand">Openverse  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../../../../_static/logo_light.svg" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="../../../../_static/logo_dark.svg" alt="Dark Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../api/index.html">Django API</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../../api/guides/index.html">Guides</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/guides/quickstart.html">Quickstart guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/guides/test.html">Testing guide</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../../api/reference/index.html">Reference</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/reference/authentication_and_throttling.html">Authentication and Throttling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/reference/search_algorithm.html">Search Algorithm</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../catalog/index.html">Airflow catalog</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="simple">
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../changelogs/index.html">Changelogs</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../../changelogs/api/index.html">API changelogs</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../changelogs/api/2023.04.27.07.29.23.html">2023.04.27.07.29.23</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../changelogs/api/2023.04.23.23.22.14.html">2023.04.23.23.22.14</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../changelogs/api/2023.04.19.00.01.39.html">2023.04.19.00.01.39</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../changelogs/api/2023.04.18.15.27.15.html">2023.04.18.15.27.15</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../changelogs/api/2023.04.12.23.29.59.html">2023.04.12.23.29.59</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../../changelogs/catalog/index.html">Catalog changelogs</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../changelogs/catalog/2023.04.27.02.43.13.html">2023.04.27.02.43.13</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../../changelogs/frontend/index.html">Frontend changelogs</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../changelogs/frontend/2023.04.23.23.07.51.html">2023.04.23.23.07.51</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../../changelogs/ingestion_server/index.html">Ingestion server changelogs</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="simple">
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../frontend/index.html">Nuxt frontend</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../../frontend/guides/index.html">Guides</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../frontend/guides/analytics.html">Analytics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../frontend/guides/develop.html">Development guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../frontend/guides/quickstart.html">Quickstart guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../frontend/guides/test.html">Running frontend tests</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../../frontend/reference/index.html">Reference</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../frontend/reference/feature_flags.html">Feature flags</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../frontend/reference/miscellaneous.html">Miscellaneous notes on the frontend</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../frontend/reference/playwright_tests.html">Playwright tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../frontend/reference/storybook_tests.html">Storybook tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../frontend/reference/testing_guidelines.html">Testing Guidelines</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../general/index.html">General development guidelines</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" role="switch" type="checkbox"/><label for="toctree-checkbox-13"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../general/deployment.html">Deployments</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../general/general_setup.html">General setup guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../general/https.html">Testing HTTPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../general/logging.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../general/publish.html">Publish</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../general/quickstart.html">Quickstart guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../general/run.html">Run</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../general/test.html">Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../general/zero-downtime-database-management.html">Zero Downtime and Database Management</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../ingestion_server/index.html">Ingestion server</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" role="switch" type="checkbox"/><label for="toctree-checkbox-14"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../../ingestion_server/guides/index.html">Guides</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" role="switch" type="checkbox"/><label for="toctree-checkbox-15"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../ingestion_server/guides/quickstart.html">Quickstart guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../ingestion_server/guides/test.html">Testing guide</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../meta/index.html">Managing the Openverse</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" role="switch" type="checkbox"/><label for="toctree-checkbox-16"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../meta/dev_flow.html">Development workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../meta/github_contribution_practices.html">GitHub contribution practices</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../../meta/ci_cd/index.html">CI + CD workflow</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" role="switch" type="checkbox"/><label for="toctree-checkbox-17"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../meta/ci_cd/actions.html">Actions</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../../meta/ci_cd/jobs/index.html">Jobs</a><input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" role="switch" type="checkbox"/><label for="toctree-checkbox-18"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../meta/ci_cd/jobs/preparation.html">Preparation jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../meta/ci_cd/jobs/frontend.html">Frontend jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../meta/ci_cd/jobs/docker_preparation.html">Docker jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../meta/ci_cd/jobs/docker_publishing.html">Docker publishing jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../meta/ci_cd/jobs/catalog.html">Catalog jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../meta/ci_cd/jobs/ingestion_server.html">Ingestion server jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../meta/ci_cd/jobs/api.html">API jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../meta/ci_cd/jobs/documentation.html">Documentation jobs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../meta/ci_cd/flow.html">Flow</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../meta/ci_cd/proof_of_functionality.html">Proof-of-functionality</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../../meta/decision_making/index.html">Openverse Decision-Making Process</a><input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" role="switch" type="checkbox"/><label for="toctree-checkbox-19"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../meta/decision_making/additional_practices.html">Additional practices</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../meta/decision_making/how_to_use.html">How to follow the process in different settings</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../meta/decision_making/process_description.html">Process description</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../../meta/documentation/index.html">Documentation</a><input class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" role="switch" type="checkbox"/><label for="toctree-checkbox-20"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../meta/documentation/guidelines.html">Documentation Guidelines</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../meta/documentation/quickstart.html">Quickstart guide</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../../../index.html">Projects</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-21" name="toctree-checkbox-21" role="switch" type="checkbox"/><label for="toctree-checkbox-21"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../planning.html">Project Planning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../templates/implementation-plan.html">Implementation Plan Template</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../templates/project-proposal.html">Project Proposal Template</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../3d_model_support/index.html">3D Model Support</a><input class="toctree-checkbox" id="toctree-checkbox-22" name="toctree-checkbox-22" role="switch" type="checkbox"/><label for="toctree-checkbox-22"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../3d_model_support/20220221-project_proposal.html">Project Proposal - 2022-02-21</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../analytics/index.html">Analytics</a><input class="toctree-checkbox" id="toctree-checkbox-23" name="toctree-checkbox-23" role="switch" type="checkbox"/><label for="toctree-checkbox-23"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../analytics/20221006-implementation_plan_frontend.html">Implentation Plan: Frontend event tracking - 2022-10-06</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../analytics/20230307-backend_service.html">Implementation Plan: Analytics backend and visualisation service - 2023-03-07</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../core_user_interface_improvement/index.html">Core User Interface Improvements</a><input class="toctree-checkbox" id="toctree-checkbox-24" name="toctree-checkbox-24" role="switch" type="checkbox"/><label for="toctree-checkbox-24"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../core_user_interface_improvement/20230314-project_proposal_core_ui_improvement.html">Project Proposal - 2023-03-14</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../document_all_media_properties/index.html">Document all media properties</a><input class="toctree-checkbox" id="toctree-checkbox-25" name="toctree-checkbox-25" role="switch" type="checkbox"/><label for="toctree-checkbox-25"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../document_all_media_properties/20230307-project_proposal.html">Due date:</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../document_all_media_properties/20230307-project_proposal.html#assigned-reviewers">Assigned reviewers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../document_all_media_properties/20230307-project_proposal.html#description">Description</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../feature_flags/index.html">Feature Flags</a><input class="toctree-checkbox" id="toctree-checkbox-26" name="toctree-checkbox-26" role="switch" type="checkbox"/><label for="toctree-checkbox-26"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../feature_flags/20220309-project_proposal.html">Project Proposal - 2022-03-09</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../frontend_ui_state_cookie/index.html">Frontend UI State Cookie</a><input class="toctree-checkbox" id="toctree-checkbox-27" name="toctree-checkbox-27" role="switch" type="checkbox"/><label for="toctree-checkbox-27"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../frontend_ui_state_cookie/20220218-project_proposal.html">2022-02-18 Project Propsal: Frontend UI State Cookie</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../monitoring/index.html">Monitoring</a><input class="toctree-checkbox" id="toctree-checkbox-28" name="toctree-checkbox-28" role="switch" type="checkbox"/><label for="toctree-checkbox-28"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../monitoring/20220307-project_proposal.html">Project Proposal - 2022-03-07</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../monorepo/index.html">Monorepo</a><input class="toctree-checkbox" id="toctree-checkbox-29" name="toctree-checkbox-29" role="switch" type="checkbox"/><label for="toctree-checkbox-29"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../monorepo/20221124-project_proposal.html">Project Proposal - 2022-11-24</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../search_relevancy_sandbox/index.html">Search Relevancy Sandbox</a><input class="toctree-checkbox" id="toctree-checkbox-30" name="toctree-checkbox-30" role="switch" type="checkbox"/><label for="toctree-checkbox-30"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../search_relevancy_sandbox/20230331-project_proposal_search_relevancy_sandbox.html">Project Proposal - 2023-03-31</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../content_report_moderation/index.html">Sensitive Content Report Moderation Initial Practices</a><input class="toctree-checkbox" id="toctree-checkbox-31" name="toctree-checkbox-31" role="switch" type="checkbox"/><label for="toctree-checkbox-31"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../content_report_moderation/20230411-project_proposal_content_report_moderation.html">2023-04-11 Project Proposal</a></li>
</ul>
</li>
<li class="toctree-l2 current has-children"><a class="reference internal" href="index.html">Detecting and Blurring Sensitive Textual Content</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-32" name="toctree-checkbox-32" role="switch" type="checkbox"/><label for="toctree-checkbox-32"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="20230309-implementation_plan_sensitive_terms_list.html">2023-03-09 Implementation Plan: Sensitive Terms List</a></li>
<li class="toctree-l3"><a class="reference internal" href="20230309-project_proposal_detecting_sensitive_textual_content.html">2023-03-09 Project Proposal</a></li>
<li class="toctree-l3 current current-page"><a class="current reference internal" href="#">2023-03-30 Implementation Plan: Filtering and designating results with sensitive textual content</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../index.html">Trust and Safety</a><input class="toctree-checkbox" id="toctree-checkbox-33" name="toctree-checkbox-33" role="switch" type="checkbox"/><label for="toctree-checkbox-33"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../20230109-trust_and_safety_preliminary_overview_and_exploration.html">2023-01-09 Initial Overview and User Stories</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../visual_regression_testing/index.html">Visual Regression Testing</a><input class="toctree-checkbox" id="toctree-checkbox-34" name="toctree-checkbox-34" role="switch" type="checkbox"/><label for="toctree-checkbox-34"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../visual_regression_testing/20220217-implementation_plan.html">Implementation Plan - 2022-02-17</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../vuex_to_pina_conversion/index.html">Pinia Conversion</a><input class="toctree-checkbox" id="toctree-checkbox-35" name="toctree-checkbox-35" role="switch" type="checkbox"/><label for="toctree-checkbox-35"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../vuex_to_pina_conversion/20220223-project_proposal.html">Project Proposal - 2022-02-23</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../terms_of_service.html">Openverse API Terms of Service</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">External links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://openverse.org">Openverse</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/WordPress/openverse">GitHub</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="edit-this-page">
  <a class="muted-link" href="https://github.com/WordPress/openverse/edit/main/documentation/projects/proposals/trust_and_safety/detecting_sensitive_textual_content/20230330-implementation_plan_filtering_and_designating_results_with_sensitive_textual_content.md" title="Edit this page">
    <svg aria-hidden="true" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4" />
      <line x1="13.5" y1="6.5" x2="17.5" y2="10.5" />
    </svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="implementation-plan-filtering-and-designating-results-with-sensitive-textual-content">
<h1>2023-03-30 Implementation Plan: Filtering and designating results with sensitive textual content<a class="headerlink" href="#implementation-plan-filtering-and-designating-results-with-sensitive-textual-content" title="Permalink to this heading">#</a></h1>
<section id="reviewers">
<h2>Reviewers<a class="headerlink" href="#reviewers" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>[x] &#64;stacimc</p></li>
<li><p>[x] &#64;dhruvkb</p></li>
</ul>
</section>
<section id="project-links">
<h2>Project links<a class="headerlink" href="#project-links" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/WordPress/openverse/issues/377">Project Thread</a></p></li>
<li><p><a class="reference internal" href="20230309-project_proposal_detecting_sensitive_textual_content.html"><span class="std std-doc">Project Proposal</span></a></p></li>
<li><p><a class="reference external" href="https://github.com/WordPress/openverse/milestone/5">Milestone (pending)</a></p></li>
<li><p><a class="reference external" href="https://github.com/WordPress/openverse/pull/911">Implementation Plan: Managing A Sensitive Terms List</a></p></li>
</ul>
<p>Please refer to additional prior art linked in the project thread. The most
significant technical prior art is this exploratory PR for creating a filtered
index: https://github.com/WordPress/openverse-api/pull/1108</p>
</section>
<section id="expected-outcomes">
<h2>Expected outcomes<a class="headerlink" href="#expected-outcomes" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Results are filtered efficiently based on a list of sensitive terms.</p></li>
<li><p>API results include a call-out on the result objects designating individual
results that have sensitive textual content.</p></li>
</ul>
</section>
<section id="tools-and-dependencies">
<h2>Tools and dependencies<a class="headerlink" href="#tools-and-dependencies" title="Permalink to this heading">#</a></h2>
<p>We will not need any new tools on the API side for this work.</p>
</section>
<section id="feature-flags">
<h2>Feature flags<a class="headerlink" href="#feature-flags" title="Permalink to this heading">#</a></h2>
<p>A new Django setting <code class="docutils literal notranslate"><span class="pre">ENABLE_FILTERED_INDEX_QUERIES</span></code> will be used in the API to
enable querying the filtered index. If this setting is not enabled, then the new
parameter will still be used (as the downstream alias of the to-be-deprecated
<code class="docutils literal notranslate"><span class="pre">mature</span></code> parameter), but it will behave exactly as the current <code class="docutils literal notranslate"><span class="pre">mature</span></code>
parameter.</p>
</section>
<section id="api-versioning">
<h2>API versioning<a class="headerlink" href="#api-versioning" title="Permalink to this heading">#</a></h2>
<p>There are no API versioning concerns. We already filter sensitive content based
on provider data, we’ll just be expanding upon that existing feature by
incorporating a new signal into the filter. I do not believe this requires a new
API version prefix or distinctly new parameter.</p>
</section>
<section id="areas-touched">
<h2>Areas touched<a class="headerlink" href="#areas-touched" title="Permalink to this heading">#</a></h2>
<p>Implementing this plan will require making changes in the following areas:</p>
<ul class="simple">
<li><p>API</p></li>
<li><p>Elasticsearch</p></li>
<li><p>Ingestion server</p></li>
<li><p>Airflow data refresh DAG factory</p></li>
</ul>
</section>
<section id="terms">
<h2>Terms<a class="headerlink" href="#terms" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>“Origin index”: This is the index we have now that includes all documents.</p></li>
<li><p>“Filtered index”: This is the index we will have after this implementation
plan is implemented. Its documents are derived from the origin index but
exclude any that have sensitive terms in their textual content.</p></li>
</ul>
</section>
<section id="overview-of-implementation-process">
<h2>Overview of implementation process<a class="headerlink" href="#overview-of-implementation-process" title="Permalink to this heading">#</a></h2>
<p>In depth descriptions of each of these steps are covered below. Each step will
be implemented as a single pull request including appropriate tests.</p>
<ol class="arabic simple">
<li><p>Update the ingestion server with a new action to use the reindex API to
generate a new index based on the origin index that only includes documents
that do not have sensitive terms in the three textual content fields
(<code class="docutils literal notranslate"><span class="pre">title</span></code>, <code class="docutils literal notranslate"><span class="pre">description</span></code>, <code class="docutils literal notranslate"><span class="pre">tags.name</span></code>). This is the filtered index.</p>
<ul class="simple">
<li><p>Requires the following:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">SENSITIVE_TERMS_URL</span></code> injected as new environment variable. See
<a class="reference internal" href="20230309-implementation_plan_sensitive_terms_list.html"><span class="std std-doc">the related IP</span></a>
for how this list will be managed. Details about how this environment
variable will be used are below.</p></li>
<li><p>Ingestion server action to create the new index using <code class="docutils literal notranslate"><span class="pre">reindex</span></code> and an
update the promote action to allow it to promote (point alias) for the
filtered index</p></li>
<li><p>Updates to the <code class="docutils literal notranslate"><span class="pre">load_sample_data.sh</span></code> script to generate the filtered
index</p></li>
<li><p>A benign list of terms to use for local testing that matches results in
the sample data</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Create a new <code class="docutils literal notranslate"><span class="pre">create_filtered_index</span></code> DAG that is triggered by the existing
data refresh DAG.</p></li>
<li><p>Update the API with the new query parameter and query the filtered index when
not including sensitive results.</p></li>
<li><p>Update the API to query the filtered index by document <code class="docutils literal notranslate"><span class="pre">_id</span></code> to deduce which
documents in a query that includes sensitive results do not have sensitive
terms. Use the resulting list of “safe” IDs to inverse the check and mark
documents that are sensitive. Simultaneously, update the media serialisers to
add the new <code class="docutils literal notranslate"><span class="pre">sensitivity</span></code> field. The serialiser field derives the array
entries based on the results of the previous step and the existing <code class="docutils literal notranslate"><span class="pre">mature</span></code>
field.</p></li>
</ol>
<p>Many thanks to &#64;robfelty for helping me find a much simpler approach to
sensitive result designation than I had originally devised. This solution is
easily 10x more intelligible and simpler to document and implement than the
others I had considered.</p>
</section>
<section id="feasibility">
<h2>Feasibility<a class="headerlink" href="#feasibility" title="Permalink to this heading">#</a></h2>
<p>Whether the approach in this implementation plan is feasible was an open
question for some time. After extensive discussions with folks who know
Elasticsearch well, I decided on this approach and was able to test it in
staging. The full process, index creation, reindex, refresh, was run on a
production dataset from before iNaturalist was added. This means the origin
index was smaller than our current one, but still large: 550 million documents.
In staging, the whole process took just over six and a half hours. The resulting
index had 444 million documents, meaning it excludes approximately 20% of the
origin index.</p>
<p>Therefore, I consider this approach feasible: it is sufficiently quick, it
produced a dataset of unsurprising size (once quoted terms were used to prevent
false positives), and is easy to implement with the tools we already have, use,
and (mostly) understand.</p>
</section>
<section id="technical-description-of-plan">
<h2>Technical description of plan<a class="headerlink" href="#technical-description-of-plan" title="Permalink to this heading">#</a></h2>
<p>Each heading refers to one of the steps in the previous section.</p>
<section id="ingestion-server-overview-step-1">
<h3>Ingestion server (overview step 1)<a class="headerlink" href="#ingestion-server-overview-step-1" title="Permalink to this heading">#</a></h3>
<p>To efficiently filter sensitive content, we will create a secondary “filtered”
index using Elasticsearch’s
<a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/docs-reindex.html"><code class="docutils literal notranslate"><span class="pre">reindex</span></code> API</a>.
This API allows us to copy documents from one index into another and using a
query to select specific documents from the origin index. With this, we can
create a large negated <code class="docutils literal notranslate"><span class="pre">multi_match</span></code> filter to exclude all results that contain
any of the sensitive terms in their textual content. This will happen in the
ingestion server as a separate step during data refresh.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">SENSITIVE_TERMS_URL</span></code> environment variable will point to a URL for a
new-line separated list of sensitive terms. The default value of this variable
will point to a localhost route to retrieve a list of testing terms. This file
will be served by Falcon in the ingestion server. In production, this variable
will point to the GitHub raw link for the <code class="docutils literal notranslate"><span class="pre">sensitive-terms.txt</span></code> document in the
sensitive terms repository created as part of
<a class="reference internal" href="20230309-implementation_plan_sensitive_terms_list.html"><span class="std std-doc">the related implementation plan</span></a>.</p>
<p>An example of the query built as a Python object iterating over a list of
sensitive terms follows:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">sensitive_terms</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SENSITIVE_TERMS_URL</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;bool&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;must_not&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;multi_match&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="c1"># ``term`` must be quoted or terms with multiple</span>
                    <span class="c1"># words will be treated with &quot;OR&quot; between each</span>
                    <span class="c1"># word, leading to false positives on innocuous words</span>
                    <span class="c1"># that are part of sensitive phrases. Quoting mitigates</span>
                    <span class="c1"># this by telling ES to treat the entire term as</span>
                    <span class="c1"># a single token.</span>
                    <span class="c1"># See the ``operator`` parameter in the match</span>
                    <span class="c1"># documentation for further details</span>
                    <span class="c1"># https://www.elastic.co/guide/en/elasticsearch/reference/7.5/query-dsl-match-query.html#match-field-params</span>
                    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
                    <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;tags.name&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">],</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">sensitive_terms</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The name of the filtered index will follow this pattern:
<code class="docutils literal notranslate"><span class="pre">{source_index}-filtered</span></code>. The filtered index alias will follow the same
pattern. This allows the API to easily query the filtered index, simply by
appending <code class="docutils literal notranslate"><span class="pre">-filtered</span></code> to the name of the index that was already being filtered.
For example, if the API is querying the filtered images index, it takes the
already designated <code class="docutils literal notranslate"><span class="pre">image</span></code> index name and appends <code class="docutils literal notranslate"><span class="pre">-filtered</span></code>: <code class="docutils literal notranslate"><span class="pre">image-filtered</span></code>.</p>
<p>In order for the new index to have the same settings as the original index
(sharding, mappings, etc), we need to take special action before calling the
reindex API. While the reindex API can create new indexes (if the destination
index specified does not exist), it does not support configuring the index in
the same request.</p>
<p>There are two approaches to ensuring the correct configuration of the filtered
index:</p>
<ol class="arabic simple">
<li><p>Create the new filtered index before calling reindex, using the
<a class="reference external" href="https://github.com/wordpress/openverse/blob/38af21c359703d3faee9e160f1ac69372661d6a2/ingestion_server/ingestion_server/es_mapping.py#L1"><code class="docutils literal notranslate"><span class="pre">index_settings</span></code></a>
function to configure this index in the same way as the origin index for the
model.</p></li>
<li><p>Create an index template that Elasticsearch will automatically apply to new
indexes that match the template pattern.</p>
<ul class="simple">
<li><p>In this option we can rely on the reindex API to create the new index as ES
will apply the template settings automatically.</p></li>
</ul>
</li>
</ol>
<p>The first is my recommendation as it matches our current approach and is trivial
to implement. The code sample at the end of this section demonstrates it in the
call to <code class="docutils literal notranslate"><span class="pre">es.indices.create</span></code>.</p>
<p>The second option, using index templates, is an interesting alternative that we
could explore in the future, especially once we remove the ingestion server.
However, it breaks significantly from our current approach to index
configuration and I do not think is worth pursuing as part of this project.</p>
<p>A sample implementation in a new <code class="docutils literal notranslate"><span class="pre">TableIndexer</span></code> method would look something like
this:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_and_populate_filtered_index</span><span class="p">(</span>
  <span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">index_suffix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">**</span><span class="n">_</span>
<span class="p">):</span>
    <span class="c1"># Rely on the alias to always created the filtered index from the up-to-date origin</span>
    <span class="n">source_index</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">index_suffix</span> <span class="o">=</span> <span class="n">index_suffix</span> <span class="ow">or</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
    <span class="n">destination_index</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">source_index</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">index_suffix</span><span class="si">}</span><span class="s2">-filtered&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">es</span><span class="o">.</span><span class="n">indices</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">index</span><span class="o">=</span><span class="n">destination_index</span><span class="p">,</span>
        <span class="n">body</span><span class="o">=</span><span class="n">index_settings</span><span class="p">(</span><span class="n">model_name</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">es</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span>
        <span class="n">body</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">source_index</span><span class="p">,</span>
                <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;bool&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;must_not&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;multi_match&quot;</span><span class="p">:</span> <span class="p">{</span>
                                    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
                                    <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;tags.name&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">],</span>
                                <span class="p">}</span>
                            <span class="p">}</span>
                            <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">SENSITIVE_TERMS</span>
                        <span class="p">]</span>
                    <span class="p">}</span>
                <span class="p">},</span>
            <span class="p">},</span>
            <span class="s2">&quot;dest&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">destination_index</span><span class="p">},</span>
        <span class="p">},</span>
        <span class="n">slices</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
        <span class="n">wait_for_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">index_name</span><span class="o">=</span><span class="n">destination_index</span><span class="p">,</span> <span class="n">change_settings</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">ping_callback</span><span class="p">()</span>
</pre></div>
</div>
<p>Please note the following important details:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">wait_for_completion</span></code> defaults to <code class="docutils literal notranslate"><span class="pre">True</span></code>, but it’s worth explicitly including
as we rely on the fact that the request will block the process until the
reindexing is finished so that we know when we can promote the index.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">slices</span></code> is set to <code class="docutils literal notranslate"><span class="pre">&quot;auto&quot;</span></code> so that Elasticsearch is free to decide the
optimal number of slices to use to parallelise the reindex.</p></li>
<li><p>The source index name is not passed explicitly to the API: instead the method
must build it. This means we match the API of other calls (making updates to
the data refresh DAG much simpler) and can avoid needing to parse the model
name from the source index name for the call to <code class="docutils literal notranslate"><span class="pre">index_settings</span></code>.</p></li>
<li><p>We explicitly refresh the index after it is finished reindexing to prime it
to be searched. ES only automatically refreshes indexes that are being
actively used, and the index should be refreshed before it starts being used.</p></li>
</ol>
<p>The creation of the new index follows the same pattern of creating the regular
index: create the index, copy the data into the index, then issue the command to
point the alias to the new index. This process is encapsulated in two actions:
the <code class="docutils literal notranslate"><span class="pre">create_and_populate_filtered_index</span></code> action described above, and the
existing <code class="docutils literal notranslate"><span class="pre">point_alias</span></code> action.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>While both processes have a “copy” step, they are notably different. The
origin index receives its documents from Postgres via ingestion workers, which
push the documents into Elasticsearch. The filtered index receives its
documents via the reindex API and does not require the ingestion workers.</p>
</div>
</section>
<section id="airflow-data-refresh-dag-factory-overview-step-2">
<h3>Airflow data refresh DAG factory (overview step 2)<a class="headerlink" href="#airflow-data-refresh-dag-factory-overview-step-2" title="Permalink to this heading">#</a></h3>
<p>To enable running filtered index creation independently of the data refresh
DAGs, we will create a separate DAG that will be triggered by the data refresh
DAGs using the
<a class="reference external" href="https://airflow.apache.org/docs/apache-airflow/stable/_api/airflow/operators/trigger_dagrun/index.html"><code class="docutils literal notranslate"><span class="pre">TriggeredDagRunOperator</span></code></a>.
The new DAG will be named <code class="docutils literal notranslate"><span class="pre">create_filtered_&lt;media_type&gt;_index</span></code>. It will not run
on a schedule (only triggered), it will have a max concurrency of one, and it
will accept the following
<a class="reference external" href="https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/params.html">Airflow params</a>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">model_name</span></code>: The model being filtered. Used as the alias of the origin index
to use.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">index_suffix</span></code>: Optionally, the suffix to add to the destination index.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">force</span></code>: Used by the data refresh DAG to override the locking behaviour of the
DAG that prevents it from running during a data refresh.</p></li>
</ul>
<p>Splitting the process into a separate DAG presents complexities that are
reflected in the last variable, <code class="docutils literal notranslate"><span class="pre">force</span></code>. Consider the following situation: a
data refresh is currently happening, but you want to create a new filtered
index. You can theoretically kick off the reindex job from the existing index.
However, after the data refresh is finished, the previous index will be deleted!
This will prevent the reindex from completing successfully. Therefore, we cannot
create a filtered index if a data refresh is currently underway. Additionally,
if filtered index creation is underway, then we cannot run a data refresh
either. Even though the data refresh process takes considerable time before it’s
ready to delete the previous index, we don’t want to play with race conditions.</p>
<p>Rather than trying to use a complex lock, we will read the data refresh DAG
status at the start of the filtered index creation DAG run to check if the
corresponding data refresh DAG is running, e.g.:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">data_refresh.dag_factory</span> <span class="kn">import</span> <span class="n">image_data_refresh</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">prevent_concurrently_running_during_data_refresh</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">image_data_refresh</span><span class="o">.</span><span class="n">get_active_runs</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">:</span>
        <span class="c1"># fail dag</span>
</pre></div>
</div>
<p>In the data refresh, however, rather than failing if the filtered index creation
DAG is running, we’ll merely tell it to wait, using the
<a class="reference external" href="https://airflow.apache.org/docs/apache-airflow/stable/_api/airflow/sensors/external_task/index.html#airflow.sensors.external_task.ExternalTaskSensor"><code class="docutils literal notranslate"><span class="pre">ExternalTaskSensor</span></code></a>.
That way it’ll already be running and no new filtered index creation runs can be
triggered between some potential lag time of the first one finishing before the
data refresh is ready.</p>
<p>When the data refresh DAG triggers filtered index creation, it should pass the
suffix of the newly created origin index so that they match. We can identify
filtered indexes created during data refresh because they will have a matching
suffix to the origin index. Manual runs of the filtered index creation DAG
should exclude this so that a new suffix is created to prevent clashing with the
existing filtered index that was created for the previous data refresh run.</p>
<p>The new DAG should be modelled on the existing data refresh DAG’s patterns for
making requests to the ingestion server. It must do the following:</p>
<ol class="arabic simple">
<li><p>Read the existing filtered index alias destination and save it (for deleting
later)</p>
<ul class="simple">
<li><p>The
<a class="reference external" href="https://github.com/WordPress/openverse-catalog/blob/75990f356ed6d79601ecf3ecd96e48c3932acb47/openverse_catalog/dags/data_refresh/data_refresh_task_factory.py#L167-L174">data refresh DAG does this here</a>.</p></li>
</ul>
</li>
<li><p>Create a new suffix to use if one is not provided in the variables</p></li>
<li><p>Call the <code class="docutils literal notranslate"><span class="pre">CREATE_AND_POPULATE_FILTERED_INDEX</span></code> action in the ingestion server
and wait for completion</p>
<ul class="simple">
<li><p>See existing data refresh DAG strategy for making and waiting for ingestion
server requests</p></li>
</ul>
</li>
<li><p>Call the <code class="docutils literal notranslate"><span class="pre">POINT_ALIAS</span></code><a class="footnote-reference brackets" href="#no-promote-action" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a> action in the ingestion server and
wait for completion.</p></li>
<li><p>Delete the previous filtered index whose canonical name we retrieved in the
first step (<code class="docutils literal notranslate"><span class="pre">DELETE_INDEX</span></code> action)</p></li>
</ol>
<p>Because the image and audio data refreshes run concurrently, it is necessary for
the filtered index creation DAG to also be a DAG factory, in the same style as
the data refresh DAG factory. This will result in a new DAG per media type. With
our current media types, that means we will add <code class="docutils literal notranslate"><span class="pre">image_filtered_index_creation</span></code>
and <code class="docutils literal notranslate"><span class="pre">audio_filtered_index_creation</span></code> DAGs.</p>
</section>
<section id="query-the-filtered-index-overview-step-3">
<h3>Query the filtered index (overview step 3)<a class="headerlink" href="#query-the-filtered-index-overview-step-3" title="Permalink to this heading">#</a></h3>
<p>We must add a new boolean query parameter to the search query serialiser,
<code class="docutils literal notranslate"><span class="pre">unstable__include_sensitive_results</span></code>. This parameter will default to the
disabled state. We will remove the <code class="docutils literal notranslate"><span class="pre">unstable</span></code> designation during the wrap-up of
this implementation plan. This parameter should also reflect the state of the
<code class="docutils literal notranslate"><span class="pre">mature</span></code> parameter: when <code class="docutils literal notranslate"><span class="pre">mature</span></code> is enabled, the new parameter should also be
enabled. This prepares us to deprecate the <code class="docutils literal notranslate"><span class="pre">mature</span></code> parameter when we remove the
<code class="docutils literal notranslate"><span class="pre">unstable</span></code> designation from the new parameter.</p>
<p>If the <code class="docutils literal notranslate"><span class="pre">mature</span></code> parameter and the new parameter are both supplied on the
request, the request should 400 with a note about the conflict and stating that
the <code class="docutils literal notranslate"><span class="pre">mature</span></code> parameter is deprecated and that <code class="docutils literal notranslate"><span class="pre">include_sensitive_results</span></code> should
be used instead.</p>
<p>While the new parameter can be used in the search controller to simplify the
code, querying the filtered index should only happen with the
<code class="docutils literal notranslate"><span class="pre">ENABLE_FILTERED_INDEX_QUERIES</span></code> setting is enabled. When that is the case and
when <code class="docutils literal notranslate"><span class="pre">unstable__include_sensitive_results</span></code> is not enabled for the request, query
the filtered index by appending the <code class="docutils literal notranslate"><span class="pre">-filtered</span></code> suffix to the index name. Update
the existing <code class="docutils literal notranslate"><span class="pre">mature</span></code> parameter handling to check
<code class="docutils literal notranslate"><span class="pre">unstable__include_sensitive_results</span></code> instead. When the new parameter is not
enabled on the request, results marked “mature” should also be filtered out, as
they are already when the <code class="docutils literal notranslate"><span class="pre">mature</span></code> parameter is not enabled on the request.</p>
<p>When the <code class="docutils literal notranslate"><span class="pre">unstable__include_sensitive_results</span></code> parameter is enabled on the
request, query the origin index so that results with sensitive textual content
are included.</p>
</section>
<section id="derive-the-list-of-sensitive-document-ids-based-on-the-filtered-index-overview-step-4">
<h3>Derive the list of sensitive document IDs based on the filtered index (overview step 4)<a class="headerlink" href="#derive-the-list-of-sensitive-document-ids-based-on-the-filtered-index-overview-step-4" title="Permalink to this heading">#</a></h3>
<p>When <code class="docutils literal notranslate"><span class="pre">unstable__include_sensitive_results</span></code> is enabled, we need to derive which
documents in the results have sensitive textual content. To do this, we will
rely on the fact that those documents are <em>not</em> in the filtered index.
Therefore, we can pull the list of <code class="docutils literal notranslate"><span class="pre">_id</span></code>s for the documents retrieved from the
origin index and query for their presence in the filtered index. If they are in
the filtered index, then we know they do not have sensitive textual content.
Something along the following lines of pseudocode:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">query_origin_index</span><span class="p">()</span>
<span class="n">result_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">({</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">})</span>

<span class="n">results_in_filtered_index</span> <span class="o">=</span> <span class="n">query_filtered_index</span><span class="p">(</span><span class="n">results_ids</span><span class="p">)</span>
<span class="n">ids_in_filtered_index</span> <span class="o">=</span> <span class="nb">set</span><span class="p">({</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results_in_filtered_index</span><span class="p">})</span>

<span class="c1"># Use set arithmatic to derive the list of sensitive documents</span>
<span class="n">sensitive_text_result_ids</span> <span class="o">=</span> <span class="n">result_ids</span> <span class="o">-</span> <span class="n">ids_in_filtered_index</span>
</pre></div>
</div>
<p>Additionally, we will query the content reports to disambiguate between provider
supplied mature results and results that users have reported as sensitive:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># continuing previous example...</span>
<span class="n">user_reported_sensitive_content_ids</span> <span class="o">=</span> <span class="n">MatureImage</span><span class="o">.</span><span class="n">objects</span>
    <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">identifier__in</span><span class="o">=</span><span class="n">result_ids</span><span class="p">)</span>
    <span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s2">&quot;identifier&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Add the resulting <code class="docutils literal notranslate"><span class="pre">sensitive_text_result_ids</span></code> and
<code class="docutils literal notranslate"><span class="pre">user_reported_sensitive_content_ids</span></code> sets to the result serialiser context so
that the media serialisers can reference them to derive the sensitive field:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">sensitivity</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">SerializerMethodField</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">get_sensitivity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;identifier&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;user_reported_sensitive_content_ids&quot;</span><span class="p">]:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;user_reported_sensitive&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;mature&quot;</span><span class="p">]:</span>
        <span class="c1"># This needs to be elif rather than a separate clause entirely</span>
        <span class="c1"># because reported content gets &quot;mature&quot; applied in Elasticsearch.</span>
        <span class="c1"># Provider supplied mature settings are only accurate if there</span>
        <span class="c1"># is not a corresponding, approved content report.</span>
        <span class="c1"># This assumes that anything with a content report that is confirmed</span>
        <span class="c1"># but not specifically de-indexed was not already marked as sensitive</span>
        <span class="c1"># by the provider and also violated our terms anyway so would be excluded.</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;provider_supplied_sensitive&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;identifier&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;sensitive_result_ids&quot;</span><span class="p">]:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;sensitive_text&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We <em>must</em> disambiguate between provider supplied sensitivity, user reported sensitivity, and sensitive textual content detected. Not only is it important to provide transparent information for <em>why</em> these documents are marked as sensitive for general use, our own frontend will need to know the difference in order to present the correct copy to users. See the discussion in <a class="reference external" href="https://github.com/WordPress/openverse/issues/791#issuecomment-1486952983">this GitHub issue</a> for more details on how this will be used.</p>
</div>
<section id="mature-results">
<h4>Mature results<a class="headerlink" href="#mature-results" title="Permalink to this heading">#</a></h4>
<p>Results with the <code class="docutils literal notranslate"><span class="pre">mature</span></code> field set to <code class="docutils literal notranslate"><span class="pre">true</span></code> will still be included in the
“filtered” index. While it is easy to exclude these results from the filtered
index, we cannot do so without making it harder to derive the list of results
with sensitive textual content based on presence in the filtered index. This is
because if the filtered index also excludes documents marked mature, then the
<code class="docutils literal notranslate"><span class="pre">origin_result_ids</span> <span class="pre">-</span> <span class="pre">filtered_result_ids</span></code> will generate a set exclusive of
documents marked mature <em>and</em> those with sensitive textual content. Critically
this means that results in the origin index that are mature but do not have
sensitive text would get marked as having sensitive text based on their presence
in the <code class="docutils literal notranslate"><span class="pre">sensitve_result_ids</span></code> set.</p>
<p>The examples below are meant to illustrate this point as it’s a bit of a
slippery concept without concrete examples (at least that’s what I found when
writing this document).</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">origin_index_results</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mature</span><span class="p">:</span> <span class="n">false</span><span class="p">},</span> <span class="c1"># no sensitive text</span>
  <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="n">mature</span><span class="p">:</span> <span class="n">true</span><span class="p">},</span> <span class="c1"># no sensitive text</span>
  <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="n">mature</span><span class="p">:</span> <span class="n">false</span><span class="p">},</span> <span class="c1"># has sensitive text</span>
  <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="n">mature</span><span class="p">:</span> <span class="n">true</span><span class="p">},</span> <span class="c1"># has sensitive text</span>
<span class="p">]</span>

<span class="n">filtered_index_results</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mature</span><span class="p">:</span> <span class="n">false</span><span class="p">},</span> <span class="c1"># no sensitive text</span>
<span class="p">]</span>

<span class="n">sensitive_result_ids</span> <span class="o">=</span> <span class="n">origin_index_result_ids</span> <span class="o">-</span> <span class="n">filtered_index_result_ids</span>
<span class="c1"># =&gt; [1, 2, 3, 4] - [1] = [2, 3, 4]</span>
</pre></div>
</div>
<p>Note how the final resulting list of IDs includes results marked mature, but
that do not have sensitive textual content (result 2). Unfortunately there is no
way around this as if we were to exclude the results marked <code class="docutils literal notranslate"><span class="pre">mature</span></code> from the
origin result IDs in the final set subtraction, we’d end up with the following
situation:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">origin_index_results</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mature</span><span class="p">:</span> <span class="n">false</span><span class="p">},</span> <span class="c1"># no sensitive text</span>
  <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="n">mature</span><span class="p">:</span> <span class="n">true</span><span class="p">},</span> <span class="c1"># no sensitive text</span>
  <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="n">mature</span><span class="p">:</span> <span class="n">false</span><span class="p">},</span> <span class="c1"># has sensitive text</span>
  <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="n">mature</span><span class="p">:</span> <span class="n">true</span><span class="p">},</span> <span class="c1"># has sensitive text</span>
<span class="p">]</span>

<span class="n">filtered_index_results</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mature</span><span class="p">:</span> <span class="n">false</span><span class="p">},</span> <span class="c1"># no sensitive text</span>
<span class="p">]</span>

<span class="n">origin_index_less_mature_result_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">origin_index</span> <span class="n">results</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;mature&quot;</span><span class="p">]]</span>
<span class="c1"># =&gt; [1, 3]</span>

<span class="n">sensitive_result_ids</span> <span class="o">=</span>
  <span class="n">origin_index_less_mature_result_ids</span> <span class="o">-</span> <span class="n">filtered_index_result_ids</span>
<span class="c1"># =&gt; [1, 3] - [1] = [3]</span>
</pre></div>
</div>
<p>Notice how we still have a problem: we’ve excluded the result that has sensitive
text <em>and</em> is marked mature (result 4).</p>
<p>It’s tempting to think we could move the mature filtering to <em>after</em> when we’ve
derived the list of sensitive result IDs. However, the problem will remain the
same: we will exclude results that are both marked mature and have sensitive
textual content:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">origin_index_results</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mature</span><span class="p">:</span> <span class="n">false</span><span class="p">},</span> <span class="c1"># no sensitive text</span>
  <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="n">mature</span><span class="p">:</span> <span class="n">true</span><span class="p">},</span> <span class="c1"># no sensitive text</span>
  <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="n">mature</span><span class="p">:</span> <span class="n">false</span><span class="p">},</span> <span class="c1"># has sensitive text</span>
  <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="n">mature</span><span class="p">:</span> <span class="n">true</span><span class="p">},</span> <span class="c1"># has sensitive text</span>
<span class="p">]</span>

<span class="n">filtered_index_results</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mature</span><span class="p">:</span> <span class="n">false</span><span class="p">},</span> <span class="c1"># no sensitive text</span>
<span class="p">]</span>

<span class="n">sensitive_result_ids</span> <span class="o">=</span> <span class="n">origin_index_result_ids</span> <span class="o">-</span> <span class="n">filtered_index_result_ids</span>
<span class="c1"># =&gt; [1, 2, 3, 4] - [1] = [2, 3, 4]</span>

<span class="n">sensitive_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">origin_index_results</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">sensitive_result_ids</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;mature&quot;</span><span class="p">]]</span>
<span class="c1"># =&gt; [3]</span>
</pre></div>
</div>
<p>Result 4 is still excluded because we can’t tell in the final operation whether
result 4 was not in the set of IDs from the filtered index <em>only</em> because it is
marked mature or if it also has sensitive textual content.</p>
<p>The only way I can think of to solve this is to have an index solely of
documents that <em>do</em> have sensitive textual content and querying it to derive the
final list of sensitive results without needing to rely on the diversely
filtered index. However, this adds a big re-indexing burden (yet another
additional index) that can be bypassed altogether if we just exclude mature
results from the filtered index to begin with. Keep in mind that the <code class="docutils literal notranslate"><span class="pre">mature</span></code>
field on documents is an indexed boolean field. Searching these fields is
extremely efficient. Any potential performance benefit at query time would be
negligible and certainly not worth the additional complications of the only
potential way to exclude mature results from the filtered index.</p>
</section>
</section>
</section>
<section id="wrap-up">
<h2>Wrap up<a class="headerlink" href="#wrap-up" title="Permalink to this heading">#</a></h2>
<p>To wrap up the implementation, once the final step has been completed and
results are filtered or correctly marked as sensitive, we will promote the
<code class="docutils literal notranslate"><span class="pre">include_sensitive_results</span></code> parameter by removing the <code class="docutils literal notranslate"><span class="pre">unstable</span></code> designation.
Additionally, we will deprecate the <code class="docutils literal notranslate"><span class="pre">mature</span></code> parameter by removing it from the
documentation. To maintain API version backwards compatibility, it should
continue to operate as an undocumented alias for the <code class="docutils literal notranslate"><span class="pre">include_sensitive_results</span></code>
parameter. Finally, we will remove the <code class="docutils literal notranslate"><span class="pre">ENABLE_FILTERED_INDEX_QUERIES</span></code> setting
and make it the default behaviour.</p>
</section>
<section id="work-streams">
<h2>Work streams<a class="headerlink" href="#work-streams" title="Permalink to this heading">#</a></h2>
<p>While the ingestion server and catalogue change could be implemented at roughly
the same time, it’s probably useful to implement the ingestion server change
first so that the catalogue change can actually be tested in the local
environment with the new API functions. That means <strong>there is a single work
stream for this implementation plan</strong>.</p>
<p>The frontend implementation is <em>not</em> entirely blocked by this plan as the
frontend can artificially set the “sensitivity” field on results for testing.
Final integration and validation of the frontend will depend on finishing this
implementation, however.</p>
<hr class="footnotes docutils" />
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="no-promote-action" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p>We cannot use the <code class="docutils literal notranslate"><span class="pre">PROMOT</span></code> action used by the regular data refresh flow
because while that action does point the alias to the newly created index,
it also promotes the API tables, which is not necessary for filtered index
creation. Therefore, we use the <code class="docutils literal notranslate"><span class="pre">POINT_ALIAS</span></code> action which only points
aliases and nothing else.</p>
</aside>
</aside>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../index.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Trust and Safety</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="20230309-project_proposal_detecting_sensitive_textual_content.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">2023-03-09 Project Proposal</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/WordPress/openverse" aria-label="GitHub"><svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">2023-03-30 Implementation Plan: Filtering and designating results with sensitive textual content</a><ul>
<li><a class="reference internal" href="#reviewers">Reviewers</a></li>
<li><a class="reference internal" href="#project-links">Project links</a></li>
<li><a class="reference internal" href="#expected-outcomes">Expected outcomes</a></li>
<li><a class="reference internal" href="#tools-and-dependencies">Tools and dependencies</a></li>
<li><a class="reference internal" href="#feature-flags">Feature flags</a></li>
<li><a class="reference internal" href="#api-versioning">API versioning</a></li>
<li><a class="reference internal" href="#areas-touched">Areas touched</a></li>
<li><a class="reference internal" href="#terms">Terms</a></li>
<li><a class="reference internal" href="#overview-of-implementation-process">Overview of implementation process</a></li>
<li><a class="reference internal" href="#feasibility">Feasibility</a></li>
<li><a class="reference internal" href="#technical-description-of-plan">Technical description of plan</a><ul>
<li><a class="reference internal" href="#ingestion-server-overview-step-1">Ingestion server (overview step 1)</a></li>
<li><a class="reference internal" href="#airflow-data-refresh-dag-factory-overview-step-2">Airflow data refresh DAG factory (overview step 2)</a></li>
<li><a class="reference internal" href="#query-the-filtered-index-overview-step-3">Query the filtered index (overview step 3)</a></li>
<li><a class="reference internal" href="#derive-the-list-of-sensitive-document-ids-based-on-the-filtered-index-overview-step-4">Derive the list of sensitive document IDs based on the filtered index (overview step 4)</a><ul>
<li><a class="reference internal" href="#mature-results">Mature results</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#wrap-up">Wrap up</a></li>
<li><a class="reference internal" href="#work-streams">Work streams</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/sphinx_highlight.js"></script>
    <script src="../../../../_static/scripts/furo.js"></script>
    <script src="../../../../_static/clipboard.min.js"></script>
    <script src="../../../../_static/copybutton.js"></script>
    <script src="https://unpkg.com/mermaid@9.4.0/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    </body>
</html>