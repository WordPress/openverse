<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Ingestion server" href="../ingestion_server/index.html" /><link rel="prev" title="Test" href="test.html" />

    <link rel="shortcut icon" href="https://raw.githubusercontent.com/WordPress/openverse/master/brand/icon.svg"/><!-- Generated with Sphinx 6.1.3 and Furo 2023.03.27 -->
        <title>Zero Downtime and Database Management - Openverse documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=fad236701ea90a88636c2a8c73b44ae642ed2a53" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Openverse  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../_static/logo_light.svg" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="../_static/logo_dark.svg" alt="Dark Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../api/index.html">Django API</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/guides/index.html">Guides</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/guides/quickstart.html">Quickstart guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/guides/test.html">Testing guide</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/reference/index.html">Reference</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/reference/authentication_and_throttling.html">Authentication and Throttling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/reference/search_algorithm.html">Search Algorithm</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../catalog/index.html">Airflow catalog</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="simple">
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../changelogs/index.html">Changelogs</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../changelogs/api/index.html">API changelogs</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../changelogs/api/2023.04.27.07.29.23.html">2023.04.27.07.29.23</a></li>
<li class="toctree-l3"><a class="reference internal" href="../changelogs/api/2023.04.23.23.22.14.html">2023.04.23.23.22.14</a></li>
<li class="toctree-l3"><a class="reference internal" href="../changelogs/api/2023.04.19.00.01.39.html">2023.04.19.00.01.39</a></li>
<li class="toctree-l3"><a class="reference internal" href="../changelogs/api/2023.04.18.15.27.15.html">2023.04.18.15.27.15</a></li>
<li class="toctree-l3"><a class="reference internal" href="../changelogs/api/2023.04.12.23.29.59.html">2023.04.12.23.29.59</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../changelogs/catalog/index.html">Catalog changelogs</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../changelogs/catalog/2023.04.27.02.43.13.html">2023.04.27.02.43.13</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../changelogs/frontend/index.html">Frontend changelogs</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../changelogs/frontend/2023.04.23.23.07.51.html">2023.04.23.23.07.51</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../changelogs/ingestion_server/index.html">Ingestion server changelogs</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="simple">
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../frontend/index.html">Nuxt frontend</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../frontend/guides/index.html">Guides</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../frontend/guides/analytics.html">Analytics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../frontend/guides/develop.html">Development guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../frontend/guides/quickstart.html">Quickstart guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../frontend/guides/test.html">Running frontend tests</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../frontend/reference/index.html">Reference</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../frontend/reference/feature_flags.html">Feature flags</a></li>
<li class="toctree-l3"><a class="reference internal" href="../frontend/reference/miscellaneous.html">Miscellaneous notes on the frontend</a></li>
<li class="toctree-l3"><a class="reference internal" href="../frontend/reference/playwright_tests.html">Playwright tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="../frontend/reference/storybook_tests.html">Storybook tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="../frontend/reference/testing_guidelines.html">Testing Guidelines</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">General development guidelines</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" role="switch" type="checkbox"/><label for="toctree-checkbox-13"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="deployment.html">Deployments</a></li>
<li class="toctree-l2"><a class="reference internal" href="general_setup.html">General setup guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="https.html">Testing HTTPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="logging.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="publish.html">Publish</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html">Quickstart guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="run.html">Run</a></li>
<li class="toctree-l2"><a class="reference internal" href="test.html">Test</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Zero Downtime and Database Management</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ingestion_server/index.html">Ingestion server</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" role="switch" type="checkbox"/><label for="toctree-checkbox-14"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../ingestion_server/guides/index.html">Guides</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" role="switch" type="checkbox"/><label for="toctree-checkbox-15"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../ingestion_server/guides/quickstart.html">Quickstart guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ingestion_server/guides/test.html">Testing guide</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../meta/index.html">Managing the Openverse</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" role="switch" type="checkbox"/><label for="toctree-checkbox-16"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../meta/dev_flow.html">Development workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../meta/github_contribution_practices.html">GitHub contribution practices</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../meta/ci_cd/index.html">CI + CD workflow</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" role="switch" type="checkbox"/><label for="toctree-checkbox-17"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../meta/ci_cd/actions.html">Actions</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../meta/ci_cd/jobs/index.html">Jobs</a><input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" role="switch" type="checkbox"/><label for="toctree-checkbox-18"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../meta/ci_cd/jobs/preparation.html">Preparation jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../meta/ci_cd/jobs/frontend.html">Frontend jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../meta/ci_cd/jobs/docker_preparation.html">Docker jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../meta/ci_cd/jobs/docker_publishing.html">Docker publishing jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../meta/ci_cd/jobs/catalog.html">Catalog jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../meta/ci_cd/jobs/ingestion_server.html">Ingestion server jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../meta/ci_cd/jobs/api.html">API jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../meta/ci_cd/jobs/documentation.html">Documentation jobs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../meta/ci_cd/flow.html">Flow</a></li>
<li class="toctree-l3"><a class="reference internal" href="../meta/ci_cd/proof_of_functionality.html">Proof-of-functionality</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../meta/decision_making/index.html">Openverse Decision-Making Process</a><input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" role="switch" type="checkbox"/><label for="toctree-checkbox-19"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../meta/decision_making/additional_practices.html">Additional practices</a></li>
<li class="toctree-l3"><a class="reference internal" href="../meta/decision_making/how_to_use.html">How to follow the process in different settings</a></li>
<li class="toctree-l3"><a class="reference internal" href="../meta/decision_making/process_description.html">Process description</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../meta/documentation/index.html">Documentation</a><input class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" role="switch" type="checkbox"/><label for="toctree-checkbox-20"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../meta/documentation/guidelines.html">Documentation Guidelines</a></li>
<li class="toctree-l3"><a class="reference internal" href="../meta/documentation/quickstart.html">Quickstart guide</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../projects/index.html">Projects</a><input class="toctree-checkbox" id="toctree-checkbox-21" name="toctree-checkbox-21" role="switch" type="checkbox"/><label for="toctree-checkbox-21"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../projects/planning.html">Project Planning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../projects/templates/implementation-plan.html">Implementation Plan Template</a></li>
<li class="toctree-l2"><a class="reference internal" href="../projects/templates/project-proposal.html">Project Proposal Template</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../projects/proposals/3d_model_support/index.html">3D Model Support</a><input class="toctree-checkbox" id="toctree-checkbox-22" name="toctree-checkbox-22" role="switch" type="checkbox"/><label for="toctree-checkbox-22"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../projects/proposals/3d_model_support/20220221-project_proposal.html">Project Proposal - 2022-02-21</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../projects/proposals/analytics/index.html">Analytics</a><input class="toctree-checkbox" id="toctree-checkbox-23" name="toctree-checkbox-23" role="switch" type="checkbox"/><label for="toctree-checkbox-23"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../projects/proposals/analytics/20221006-implementation_plan_frontend.html">Implentation Plan: Frontend event tracking - 2022-10-06</a></li>
<li class="toctree-l3"><a class="reference internal" href="../projects/proposals/analytics/20230307-backend_service.html">Implementation Plan: Analytics backend and visualisation service - 2023-03-07</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../projects/proposals/core_user_interface_improvement/index.html">Core User Interface Improvements</a><input class="toctree-checkbox" id="toctree-checkbox-24" name="toctree-checkbox-24" role="switch" type="checkbox"/><label for="toctree-checkbox-24"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../projects/proposals/core_user_interface_improvement/20230314-project_proposal_core_ui_improvement.html">Project Proposal - 2023-03-14</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../projects/proposals/document_all_media_properties/index.html">Document all media properties</a><input class="toctree-checkbox" id="toctree-checkbox-25" name="toctree-checkbox-25" role="switch" type="checkbox"/><label for="toctree-checkbox-25"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../projects/proposals/document_all_media_properties/20230307-project_proposal.html">Due date:</a></li>
<li class="toctree-l3"><a class="reference internal" href="../projects/proposals/document_all_media_properties/20230307-project_proposal.html#assigned-reviewers">Assigned reviewers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../projects/proposals/document_all_media_properties/20230307-project_proposal.html#description">Description</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../projects/proposals/feature_flags/index.html">Feature Flags</a><input class="toctree-checkbox" id="toctree-checkbox-26" name="toctree-checkbox-26" role="switch" type="checkbox"/><label for="toctree-checkbox-26"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../projects/proposals/feature_flags/20220309-project_proposal.html">Project Proposal - 2022-03-09</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../projects/proposals/frontend_ui_state_cookie/index.html">Frontend UI State Cookie</a><input class="toctree-checkbox" id="toctree-checkbox-27" name="toctree-checkbox-27" role="switch" type="checkbox"/><label for="toctree-checkbox-27"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../projects/proposals/frontend_ui_state_cookie/20220218-project_proposal.html">2022-02-18 Project Propsal: Frontend UI State Cookie</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../projects/proposals/monitoring/index.html">Monitoring</a><input class="toctree-checkbox" id="toctree-checkbox-28" name="toctree-checkbox-28" role="switch" type="checkbox"/><label for="toctree-checkbox-28"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../projects/proposals/monitoring/20220307-project_proposal.html">Project Proposal - 2022-03-07</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../projects/proposals/monorepo/index.html">Monorepo</a><input class="toctree-checkbox" id="toctree-checkbox-29" name="toctree-checkbox-29" role="switch" type="checkbox"/><label for="toctree-checkbox-29"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../projects/proposals/monorepo/20221124-project_proposal.html">Project Proposal - 2022-11-24</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../projects/proposals/search_relevancy_sandbox/index.html">Search Relevancy Sandbox</a><input class="toctree-checkbox" id="toctree-checkbox-30" name="toctree-checkbox-30" role="switch" type="checkbox"/><label for="toctree-checkbox-30"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../projects/proposals/search_relevancy_sandbox/20230331-project_proposal_search_relevancy_sandbox.html">Project Proposal - 2023-03-31</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../projects/proposals/trust_and_safety/content_report_moderation/index.html">Sensitive Content Report Moderation Initial Practices</a><input class="toctree-checkbox" id="toctree-checkbox-31" name="toctree-checkbox-31" role="switch" type="checkbox"/><label for="toctree-checkbox-31"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../projects/proposals/trust_and_safety/content_report_moderation/20230411-project_proposal_content_report_moderation.html">2023-04-11 Project Proposal</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../projects/proposals/trust_and_safety/detecting_sensitive_textual_content/index.html">Detecting and Blurring Sensitive Textual Content</a><input class="toctree-checkbox" id="toctree-checkbox-32" name="toctree-checkbox-32" role="switch" type="checkbox"/><label for="toctree-checkbox-32"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../projects/proposals/trust_and_safety/detecting_sensitive_textual_content/20230309-implementation_plan_sensitive_terms_list.html">2023-03-09 Implementation Plan: Sensitive Terms List</a></li>
<li class="toctree-l3"><a class="reference internal" href="../projects/proposals/trust_and_safety/detecting_sensitive_textual_content/20230309-project_proposal_detecting_sensitive_textual_content.html">2023-03-09 Project Proposal</a></li>
<li class="toctree-l3"><a class="reference internal" href="../projects/proposals/trust_and_safety/detecting_sensitive_textual_content/20230330-implementation_plan_filtering_and_designating_results_with_sensitive_textual_content.html">2023-03-30 Implementation Plan: Filtering and designating results with sensitive textual content</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../projects/proposals/trust_and_safety/index.html">Trust and Safety</a><input class="toctree-checkbox" id="toctree-checkbox-33" name="toctree-checkbox-33" role="switch" type="checkbox"/><label for="toctree-checkbox-33"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../projects/proposals/trust_and_safety/20230109-trust_and_safety_preliminary_overview_and_exploration.html">2023-01-09 Initial Overview and User Stories</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../projects/proposals/visual_regression_testing/index.html">Visual Regression Testing</a><input class="toctree-checkbox" id="toctree-checkbox-34" name="toctree-checkbox-34" role="switch" type="checkbox"/><label for="toctree-checkbox-34"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../projects/proposals/visual_regression_testing/20220217-implementation_plan.html">Implementation Plan - 2022-02-17</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../projects/proposals/vuex_to_pina_conversion/index.html">Pinia Conversion</a><input class="toctree-checkbox" id="toctree-checkbox-35" name="toctree-checkbox-35" role="switch" type="checkbox"/><label for="toctree-checkbox-35"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../projects/proposals/vuex_to_pina_conversion/20220223-project_proposal.html">Project Proposal - 2022-02-23</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../terms_of_service.html">Openverse API Terms of Service</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">External links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://openverse.org">Openverse</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/WordPress/openverse">GitHub</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="edit-this-page">
  <a class="muted-link" href="https://github.com/WordPress/openverse/edit/main/documentation/general/zero-downtime-database-management.md" title="Edit this page">
    <svg aria-hidden="true" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4" />
      <line x1="13.5" y1="6.5" x2="17.5" y2="10.5" />
    </svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="zero-downtime-and-database-management">
<h1>Zero Downtime and Database Management<a class="headerlink" href="#zero-downtime-and-database-management" title="Permalink to this heading">#</a></h1>
<p>Openverse practices zero-downtime deployments. This puts a handful of
constraints on our database migration and data management practices. This
document describes how to ensure migrations can be deployed with zero downtime
and how to implement and manage long-running data migrations.</p>
<p>Zero-downtime deployments are important to ensure service reliability. Following
the practices that enable zero-downtime deployments also promotes best practices
like ensuring changes are incremental and more easily reversible.</p>
<section id="external-resources">
<h2>External resources<a class="headerlink" href="#external-resources" title="Permalink to this heading">#</a></h2>
<p>This document assumes a general understanding of relational databases, including
concepts like database tables, columns, constraints, and indexes. If this is not
something you are familiar with,
<a class="reference external" href="https://en.wikipedia.org/wiki/Relational_database">the Wikipedia article on relation databases</a>
is a good starting point.</p>
<p>Django’s
<a class="reference external" href="https://docs.djangoproject.com/en/4.1/topics/migrations/">database migration documentation</a>
also contains helpful background knowledge, though this document takes a more
general approach than addressing only Django specific scenarios.</p>
</section>
<section id="terms">
<h2>Terms<a class="headerlink" href="#terms" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>“Zero-downtime deployment”: An application deployment that does not result in
any period of time during which a service is inaccessible. For the purposes of
Openverse, these require running two versions of the application at once that
share the same underlying database infrastructure.</p></li>
<li><p>“Schema”: The structure of a database. The tables, columns, and their types.</p></li>
<li><p>“Downtime deployment”: An application deployment that does result in a period
of time during which a service is inaccessible. The Openverse project goes to
great lengths to avoid these. These are often caused when a new version of an
application is incompatible with the underlying infrastructure of the
previously deployed version.</p></li>
<li><p>“Database migration”: A change to the schema of a database. Common migrations
include the addition or removal of tables and columns.</p></li>
<li><p>“Data transformation”: A change to the data held in a database that does not
include (but can be related) to a database migration. Common examples include
backfilling data to remove null values from a column or moving data between
two related columns.</p></li>
<li><p>“Data migration”: A data transformation that is executed as part of a Django
migration.</p></li>
<li><p>“Long-running data transformation”: A data transformation that lasts longer
than a few seconds. Long-running data transformations are commonly caused by
the modification of massive data, especially data in indexed columns.</p></li>
</ul>
</section>
<section id="how-zero-downtime-deployments-work">
<h2>How zero-downtime deployments work<a class="headerlink" href="#how-zero-downtime-deployments-work" title="Permalink to this heading">#</a></h2>
<p>To understand the motivations of these best practices, it is important to
understand how zero-downtime deployments are implemented. Openverse uses the
<a class="reference external" href="https://en.wikipedia.org/wiki/Blue-green_deployment">blue-green deployment strategy</a>.
The blue-green strategy requires running the new version of the application and
the previous version at the same time during the duration of the deployment.
This allows us to replace the multiple, load-balanced instances of our
application one-by-one. As a result, we are able to verify the health of the
instances running the new version, before fully replacing our entire cluster of
application instances with the new version. At all times during a successful
deployment process, both versions of the application must be fully operable and
healthy and able to handle requests. During deployment, the load-balancer will
send requests to both the previous and new versions of the application during
the entire time of the deployment, which can be several minutes. This requires
both versions of the application to be strictly compatible with the underlying
database schema.</p>
</section>
<section id="what-causes-downtime-during-a-deployment">
<h2>What causes downtime during a deployment?<a class="headerlink" href="#what-causes-downtime-during-a-deployment" title="Permalink to this heading">#</a></h2>
<p>The most common cause of downtime during a deployment are database schema
incompatibilities between the previous and new version of the application. The
classic example of a schema incompatibility involves column name changes.
Imagine there is a column on a table of audio files called “length”, but we
wanted to change the column name to specify the expected units, to make it
clearer for new contributors. If we simply change the name of the column to
“length_ms”, then when the new version of the application deploys, it will apply
the migration to change the name. The new version will, of course, work just
fine, in this case. However, during deployments, the previous version of the
application will still be running for a period of time. Requests by the previous
version of the application to retrieve the “length” column with fail
catastrophically because the “length” column will no longer exist! It has been
renamed to “length_ms”. If we prevented the new version of the application from
applying the migration, the same issue would arise, but for the new versions as
the “length_ms” column would not yet exist. This, in addition to column
data-type changes, is the most common reason why downtime would be required
during a deployment process that is otherwise capable of deploying without
downtime. When schema incompatibilities arise between new and the previous
version of an application, it is impossible to safely serve requests from both
using the same underlying database.</p>
<p>Other causes are variations on this same pattern: a shared dependency is neither
forward nor backwards compatible between two subsequent versions of the
application.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This issue of incompatibility only applies to <em>subsequent</em> versions
of an application because only subsequent versions are ever deployed
simultaneously with the same underlying support infrastructure. So long as
there is at least one version between them, application versions may and
indeed sometimes do have fundamental incompatibilities with each other and
could not be simultaneously deployed.</p>
</div>
</section>
<section id="how-to-achieve-zero-downtime-deployments">
<h2>How to achieve zero-downtime deployments<a class="headerlink" href="#how-to-achieve-zero-downtime-deployments" title="Permalink to this heading">#</a></h2>
<p>Sometimes you need to change the name of a column or introduce some other,
non-backwards compatible change to the database schema. Luckily, this is still
possible, even with zero-downtime deployments, though admittedly the process is
more tedious.</p>
<p>Continuing with the column name change case-study, the following approach must
be followed.</p>
<ol class="arabic simple">
<li><p>Create a new column with the desired name and data type. The new column must
be nullable and should default to null. This step should happen with a new
version of the application that continues to use the existing column.</p></li>
<li><p>If the column is written to by the application, deploy a new version that
starts writing new or updated data to both columns. It should read the data
from the new column and only fall back to the old column if the new column is
not yet populated.</p></li>
<li><p>Use a data transformation management command to move data from the previous
column to the new column. To find the rows that need updating, iterate
through the table by querying for rows that do not have a value in the new
column yet. Because the version of the application running at this point is
writing and reading from the new column (falling back to the old for reads
when necessary), the query will eventually return zero rows.</p></li>
<li><p>Once the data transformation is complete, deploy a new version of the
application that removes the old column and the fallback reads to it and only
uses the new column. Also, add the corresponding constraints for the said
column if required, e.g. non-nullable, default value, etc.</p></li>
</ol>
<p>To reiterate, yes, this is a much more tedious process. However, the benefits to
this approach are listed below.</p>
<p>Relatively similar processes and patterns can be applied to other
“downtime-causing” database changes. These are covered in
<a class="reference external" href="https://gist.github.com/majackson/493c3d6d4476914ca9da63f84247407b">this GitHub gist</a>
with specific instructions for handling them in a Django context.</p>
<section id="benefits-of-this-approach">
<h3>Benefits of this approach<a class="headerlink" href="#benefits-of-this-approach" title="Permalink to this heading">#</a></h3>
<section id="zero-downtime">
<h4>Zero-downtime<a class="headerlink" href="#zero-downtime" title="Permalink to this heading">#</a></h4>
<p>The entire point, of course. This benefits everyone who depends on the
application’s uptime and reliability.</p>
</section>
<section id="reversibility">
<h4>Reversibility<a class="headerlink" href="#reversibility" title="Permalink to this heading">#</a></h4>
<p>If the new version of the application has a critical bug, whether related to the
data changes or not, we can revert each step to the previous version without
issue or data loss. Even during the data transformation process, because the
version of the application running is updating both columns, if you have to
revert to the first version (or even earlier) that doesn’t use the new column,
the old column will still have up-to-date data and no user data will be lost.
This would complicate the data migration process, however, as previous versions
of the application will not be updating the new column and would likely require
deleting the data from the new column to start the data migration process over
from the start. This can cause massive time consumption but is overall less of a
headache than data loss or fully broken deployments.</p>
</section>
<section id="intentionality-and-expediency">
<h4>Intentionality and expediency<a class="headerlink" href="#intentionality-and-expediency" title="Permalink to this heading">#</a></h4>
<p>Due to the great lengths it takes to change a column name, the process will
inevitably cause contributors to ask themselves: is this worth it? While
changing the name of a column can be helpful to disambiguate the data in the
column, using a model attribute alias can be just as helpful without any of the
disruption or time of a data transformation. These kinds of questions prompt us
to make expedient choices that deliver features, bug fixes, and developer
experience improvements faster.</p>
</section>
<section id="shorter-deployment-times">
<h4>Shorter deployment times<a class="headerlink" href="#shorter-deployment-times" title="Permalink to this heading">#</a></h4>
<p>Ideally maintainers orchestrating a production deployment of the service are
keenly aware of the progress of the deployment. This is only a realistic and
sustainable expectation, however, if deployments take a “short” amount of time.
What “short” means is up for debate, but an initial benchmark can be the
Openverse production frontend deployments, which currently take about 10
minutes. Longer than this seems generally unreasonable to expect someone to keep
a very close eye on the process. Sticking to zero-downtime deployments helps
keep short deployments the norm. Even though it sometimes asks us to deploy more
<em>often</em>, those deployments can—and in all likelihood, should—be spread over
multiple days. This makes the expectation of keeping a close watch on the
deployment more sustainable long-term and helps encourage us to deploy more
often. In turn, this means new features and bug fixes get to production sooner.</p>
</section>
<section id="possibility-to-throttle">
<h4>Possibility to throttle<a class="headerlink" href="#possibility-to-throttle" title="Permalink to this heading">#</a></h4>
<p>Management commands that iterate over data progressively can be throttled to
prevent excessive load on the database or other related services that need to be
accessed.</p>
</section>
<section id="unit-testing">
<h4>Unit testing<a class="headerlink" href="#unit-testing" title="Permalink to this heading">#</a></h4>
<p>Management command data migrations can be far more easily unit tested using our
existing tools and fixture utilities.</p>
</section>
</section>
<section id="long-running-migrations">
<h3>Long running migrations<a class="headerlink" href="#long-running-migrations" title="Permalink to this heading">#</a></h3>
<p>Sometimes long-running schema changes are unavoidable. In these cases, provided
that the instructions above are followed to prevent the need for downtime, it is
reasonable to take alternative approaches to deploying the migration.</p>
<p>At the moment we do not have specific recommendations or policies regarding
these hopefully rare instances. If you come across the need for this, please
carefully consider the reasons why it is necessary in the particular case and
document the steps taken to prepare and deploy the migration. Please update this
document with any general findings or advice, as applicable.</p>
</section>
</section>
<section id="django-management-command-based-data-transformations">
<h2>Django management command based data transformations<a class="headerlink" href="#django-management-command-based-data-transformations" title="Permalink to this heading">#</a></h2>
<section id="why-use-management-commands-for-data-transformations-instead-of-django-migrations">
<h3>Why use management commands for data transformations instead of Django migrations?<a class="headerlink" href="#why-use-management-commands-for-data-transformations-instead-of-django-migrations" title="Permalink to this heading">#</a></h3>
<p>Django comes with a data transformation feature built in that allows executing
data transformations during the migration process. Transformations are described
in Django’s ORM and executed in a single pass at migration time. If you want to
move data between two columns, it is trivial to do so with these “data
migrations” and Django makes it just as easy.
<a class="reference external" href="https://docs.djangoproject.com/en/4.1/topics/migrations/#data-migrations">Documentation for this Django feature is available here</a>.</p>
<p>When considering the potential issues with using Django migrations for data
transformations with our current deployment strategy, keep in mind the following
details:</p>
<ul class="simple">
<li><p>Migrations are run <em>at the time of deployment</em> by the first instance of the
new version of the application that runs in the pool.</p>
<ul>
<li><p><strong>Note</strong>: This specific detail will only be the case once we’ve fully
migrated to ECS based deployments. For now one of the people deploying the
application manually runs the migrations before deploying. The effect is the
same though: we end up with a version of the application running against a
database schema that it’s not entirely configured to work with. Whether that
is an issue depends solely on whether the practices described in this
document regarding migrations have been followed.</p></li>
</ul>
</li>
<li><p>Deployments should be timely so that developers are able to reasonably monitor
their progress and have clear expectations for how long a deployment should
take. Ideally a full production deployment should not take much longer than 10
minutes once the Docker images are built. Those minutes are already spent by
the process ECS undergoes to deploy a new version of the application.</p></li>
</ul>
<p>With those two key details in mind, the main deficiency of using migrations for
data transformations may already be evident: time. Django migration based data
transformations dealing with certain smaller tables may not take very long and
this issue, in some cases, might not be applicable. However, because it is
extremely difficult to predetermine the amount of time a migration will take,
even data transformations for small datasets should still heed the
recommendation to use management commands. In particular, it can be difficult to
predict tables with indexes (especially unique constraints) will perform during
a SQL data migration.</p>
<p>Realistically (and provided it is avoidable), any Django migration that takes
longer than 30 or so seconds, is not acceptable for our current deployment
strategy. Because the vast majority of them will take longer than a few seconds,
there is a strong, blanket recommendation against using them. Exceptions may
exist for this recommendation, however. If you’re working on an issue that
involves a data transformation, and you think a migration is truly the best tool
for the job and can demonstrate that it will not take longer than 30 seconds in
production, then please include these details in the PR.</p>
</section>
<section id="general-rules-for-data-transformations">
<h3>General rules for data transformations<a class="headerlink" href="#general-rules-for-data-transformations" title="Permalink to this heading">#</a></h3>
<p>These rules apply for data transformations executed as management commands or
otherwise.</p>
<section id="data-transformations-must-be-idempotent">
<h4>Data transformations must be <a class="reference external" href="https://en.wikipedia.org/wiki/Idempotence">idempotent</a><a class="headerlink" href="#data-transformations-must-be-idempotent" title="Permalink to this heading">#</a></h4>
<p>This one particularly applies to management commands because they can
theoretically be run multiple times, either by accident or as an attempt to
recover from or continue after a failure.</p>
<p>Idempotency is important for data transformations because it prevents
unnecessary duplicate processing of data. Idempotency can be achieved in three
ways:</p>
<ol class="arabic simple">
<li><p>By checking the state of the data and only applying the transformation to
rows for which the transformation has not yet been applied. For example, if
moving data between two columns, only process rows for which the new column
is null. Once data has been moved for a row, it will no longer be null and
will be ignored from the query.</p></li>
<li><p>By checking a timestamp available for each row before which it is known that
data transformations have already been applied.</p></li>
<li><p>By caching a list of identifiers for already processed rows in Redis.</p></li>
</ol>
</section>
<section id="data-transformations-should-not-be-destructive">
<h4>Data transformations should not be destructive<a class="headerlink" href="#data-transformations-should-not-be-destructive" title="Permalink to this heading">#</a></h4>
<p>Data transformations should avoid being destructive, if possible. Sometimes it
is avoidable because data needs to be updated “in place”. In these cases, it is
imperative to save a list of modified rows (for example, in a Redis set) so that
the transformation can be reversed if necessary.</p>
</section>
</section>
<section id="if-a-django-migration-must-be-used">
<h3>If a Django migration <em>must</em> be used<a class="headerlink" href="#if-a-django-migration-must-be-used" title="Permalink to this heading">#</a></h3>
<p>In the rare case where a Django migration must be used, keep in mind that using
a
<a class="reference external" href="https://docs.djangoproject.com/en/4.1/howto/writing-migrations/#non-atomic-migrations">non-atomic migration</a>
can help make it easier to recover from unexpected errors without causing the
entire transformation process to be reversed.</p>
</section>
</section>
<section id="environment-variables">
<h2>Environment variables<a class="headerlink" href="#environment-variables" title="Permalink to this heading">#</a></h2>
<p>In addition to careful database management, we must also take care when we
introduce or update environment variables and ensure that it is done in a way
compatible with zero-downtime deployments. While some issues and difficulties
are shared between zero-downtime database schema changes and environment
variable management, environment variables do have their own distinct issues to
be aware of.</p>
<section id="how-we-configure-environment-variables">
<h3>How we configure environment variables<a class="headerlink" href="#how-we-configure-environment-variables" title="Permalink to this heading">#</a></h3>
<p>In order to understand the potential issues that can arise in managing
environment variables, it is necessary to first understand the mechanisms used
to management them and how they are propogated to application instances.</p>
<p>Environment variables for applications and their environments are configured and
managed in the <em>task definition template</em>. The ECS service for each application
does not run the template. Rather, it runs a <em>rendered task definition</em> derived
from the template. The critical piece here is that services run task definitions
<em>based</em> on the template, but not the template itself. Therefore, to get new or
updated environment variables, it is necessary to render new application task
definitions based on the templates. <strong>Updating the template does not
automatically update the application</strong>.</p>
<p>New rendered task definitions are created during runs of the
<a class="reference external" href="https://wordpress.github.io/openverse/guides/deployment.html#deployment-workflow">deployment workflow</a>.
That means the following situations will render a new task definition:</p>
<ul class="simple">
<li><p>New version deployments, including automated staging deployments and manual
production deployments</p></li>
<li><p>Manual rollbacks where the deployment workflow is newly dispatched</p></li>
<li><p>Redeployments of applications to the same version</p></li>
</ul>
<p>New task definitions are <em>not</em> rendered during <em>automated rollbacks</em>. That is,
if a deployment process fails, the previous working task definition revision is
used without modification. <strong>Notably, this includes the previous configuration
of environment variables</strong>.</p>
<p>To restate for clarity: provided the task definition template environment
variables have been updated, the only way to get new or updated environment
variables into a running application is by forcing a new deployment which in
turn creates a new task definition revision.</p>
<p>It can be easy to tangle up the concept of the application version and the task
definition revision, but they are separate. If an application is deployed to v1,
then to v2, then rolled back to v1, there are only two application versions.
However, there are now <em>three</em> task definition revisions: one for each
deployment and one for the rollback. To further reiterate the nuance here,
rolling back the application version <em>does not use previous task definitions</em>
and will render a new task definition pointing to the rolled back application
version, but using the latest version of the template.</p>
<p>Put yet another way: regardless of the application version being deployed,
whether it is new, existing, or old, a new task definition revision is always
created using the latest task definition template.</p>
<p>This is restated several times in this section because it is a critical nuance
that is easy to lose sight of, in particular in the course of an emergency
rollback where details like this are easy to miss.</p>
</section>
<section id="what-is-distinct-from-column-management">
<h3>What is distinct from column management<a class="headerlink" href="#what-is-distinct-from-column-management" title="Permalink to this heading">#</a></h3>
<p>The difference between environment variable and column management comes down to
the fact that with the database, the exact same database is being used by two
different running versions of the application. For environment variables, the
previously running version of the application will continue to use the
environment variable configuration defined in the previous task definition
revision used to run that instance. Environment variables are not automatically
updated for the running application. This means that if a deployment was very
carefully orchestrated, we do not necessarily need to worry about backwards
incompatible changes, and even in the
<a class="reference internal" href="#manual-rollbacks-after-removing-an-environment-variable-or-updating-its-format">worst case described below</a>,
it is still possible to recover by following an additional step (re-updating the
template before rolling back).</p>
<p>Generally environment variables require far less care and attention than
database management when it comes to maintaining zero-downtime deployments.
However, maintainers should still understand how this process works so that they
can handle situations where it does come up (particularly with manual rollbacks
and the removal of environment variables).</p>
</section>
<section id="when-to-update-environment-variables">
<h3>When to update environment variables<a class="headerlink" href="#when-to-update-environment-variables" title="Permalink to this heading">#</a></h3>
<p>Because environment variables are updated in the task definition template, they
must be updated <em>before</em> the new version of the application depending on the
variable is deployed. This includes staging, which automatically deploys on
pushes to <code class="docutils literal notranslate"><span class="pre">main</span></code>. If a new environment variable is required and has no
acceptable default behaviour if not configured—i.e., the application will crash
if it is not present or the behaviour when it is not present is incompatible
with the environment—then it must be added to the task definition template for
the application and environment before the application is deployed. For staging,
this means updating the task definition template before merging the PR. For
production, this means updating the task definition template before running the
production deployment workflow.</p>
<p>It is generally best practice to configure acceptable default behaviours for
undefined environment variables, but sometimes it’s not possible to do so and in
these cases it is imperative to update the task definition template before
triggering a deployment (whether automated or manual).</p>
<p>If the task definition template is updated <em>after</em> the fact (whether because we
forgot to do it beforehand or for any other reason), then the application will
need to be redeployed so that a new task definition is created using the latest
template revision with the updated variables.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><em>Any</em> redeployment after the template is updated will receive the updated
variables. That means that, for example, if staging is automatically deployed
due to a push to <code class="docutils literal notranslate"><span class="pre">main</span></code> after updating the template, it is not necessary to
further redeploy staging for the application to get the updated variables. If
the timing of each is within seconds, however, it’s best not to risk it and
just redeploy staging if you have any doubts.</p>
</div>
</section>
<section id="manual-rollbacks-after-removing-an-environment-variable-or-updating-its-format">
<h3>Manual rollbacks after removing an environment variable or updating its format<a class="headerlink" href="#manual-rollbacks-after-removing-an-environment-variable-or-updating-its-format" title="Permalink to this heading">#</a></h3>
<p>This is the primary situation where an environment variable change could cause
an issue if not handled carefully. Imagine a situation where we’ve developed
changes for one of our applications that removes the need for a previously
required environment variable. For example, imagine we decided to get rid of
Sentry and removed the
<a class="reference external" href="https://github.com/wordpress/openverse/blob/72087873e8383a656842cb6152a8f4391250cbbc/frontend/src/utils/sentry-config.ts#L11"><code class="docutils literal notranslate"><span class="pre">SENTRY_DSN</span></code></a>
environment variable from the template task definition in preparation for the
subsequent deployment. Imagine further that for some reason, we needed
immediately to rollback this change and for Sentry to return to working order.
Because the latest task definition template is always used to create the task
definition for every deployment, we would first need to update the template to
add back the environment variable. If we didn’t then the manual rollback would
use the same template as the original deployment that didn’t include the
environment variable.</p>
<p><strong>The best way to avoid this complication is to leave unneeded environment
variables in the template until after the application version that does not need
them is confirmed to work as expected</strong>. After that, the template may be safely
updated to remove the environment variable and any subsequent deployments will
not include the variable. This is similar to how we remove columns from the
database schema: deploy the code that doesn’t use the variable/column first,
<em>then</em> remove the variable/column.</p>
<p>Note that this same issue applies when making non-backwards compatible changes
to environment variable formats. For this reason, it’s best to follow the
zero-downtime column data-type approach in this case and create a new
environment variable name for the new format. This allows both the old and the
new environment variable formats to co-exist and a manual rollback to occur
without the need to re-add the previous variable to the template.</p>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../ingestion_server/index.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Ingestion server</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="test.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Test</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/WordPress/openverse" aria-label="GitHub"><svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Zero Downtime and Database Management</a><ul>
<li><a class="reference internal" href="#external-resources">External resources</a></li>
<li><a class="reference internal" href="#terms">Terms</a></li>
<li><a class="reference internal" href="#how-zero-downtime-deployments-work">How zero-downtime deployments work</a></li>
<li><a class="reference internal" href="#what-causes-downtime-during-a-deployment">What causes downtime during a deployment?</a></li>
<li><a class="reference internal" href="#how-to-achieve-zero-downtime-deployments">How to achieve zero-downtime deployments</a><ul>
<li><a class="reference internal" href="#benefits-of-this-approach">Benefits of this approach</a><ul>
<li><a class="reference internal" href="#zero-downtime">Zero-downtime</a></li>
<li><a class="reference internal" href="#reversibility">Reversibility</a></li>
<li><a class="reference internal" href="#intentionality-and-expediency">Intentionality and expediency</a></li>
<li><a class="reference internal" href="#shorter-deployment-times">Shorter deployment times</a></li>
<li><a class="reference internal" href="#possibility-to-throttle">Possibility to throttle</a></li>
<li><a class="reference internal" href="#unit-testing">Unit testing</a></li>
</ul>
</li>
<li><a class="reference internal" href="#long-running-migrations">Long running migrations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#django-management-command-based-data-transformations">Django management command based data transformations</a><ul>
<li><a class="reference internal" href="#why-use-management-commands-for-data-transformations-instead-of-django-migrations">Why use management commands for data transformations instead of Django migrations?</a></li>
<li><a class="reference internal" href="#general-rules-for-data-transformations">General rules for data transformations</a><ul>
<li><a class="reference internal" href="#data-transformations-must-be-idempotent">Data transformations must be idempotent</a></li>
<li><a class="reference internal" href="#data-transformations-should-not-be-destructive">Data transformations should not be destructive</a></li>
</ul>
</li>
<li><a class="reference internal" href="#if-a-django-migration-must-be-used">If a Django migration <em>must</em> be used</a></li>
</ul>
</li>
<li><a class="reference internal" href="#environment-variables">Environment variables</a><ul>
<li><a class="reference internal" href="#how-we-configure-environment-variables">How we configure environment variables</a></li>
<li><a class="reference internal" href="#what-is-distinct-from-column-management">What is distinct from column management</a></li>
<li><a class="reference internal" href="#when-to-update-environment-variables">When to update environment variables</a></li>
<li><a class="reference internal" href="#manual-rollbacks-after-removing-an-environment-variable-or-updating-its-format">Manual rollbacks after removing an environment variable or updating its format</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="https://unpkg.com/mermaid@9.4.0/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    </body>
</html>