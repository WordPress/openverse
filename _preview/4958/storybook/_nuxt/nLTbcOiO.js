import{d as U,u as T}from"./xwskLidM.js";import{d as v}from"./DivIZ7Lb.js";import{w as W}from"./C0voMBC3.js";import{h as j,r as K}from"./Dt-H8hG_.js";import{N as _,c as Y}from"./CTON8dBl.js";import{I as p,b as y,V as B,M as V,A as g,h as w,a as k,m as G,j as J,e as N,u as X,g as d,k as D}from"./QKPGpISV.js";import{d as b}from"./CzMkt2mC.js";import{g as Z}from"./Cpj98o6Y.js";import{a as ee}from"./Ci7G4jyV.js";import{f as te}from"./Xs_VBmP5.js";import{u as Q}from"./CeIx8O89.js";const se=[429,500,404],L=e=>e&&se.includes(e),re=e=>{const{statusCode:t,code:s}=e;return!(L(t)||s===_)},qe=e=>!L(e.statusCode)&&Y.includes(e.code);var ie=ne;function F(e){return e instanceof Buffer?Buffer.from(e):new e.constructor(e.buffer.slice(),e.byteOffset,e.length)}function ne(e){if(e=e||{},e.circles)return ce(e);const t=new Map;if(t.set(Date,i=>new Date(i)),t.set(Map,(i,l)=>new Map(r(Array.from(i),l))),t.set(Set,(i,l)=>new Set(r(Array.from(i),l))),e.constructorHandlers)for(const i of e.constructorHandlers)t.set(i[0],i[1]);let s=null;return e.proto?h:c;function r(i,l){const n=Object.keys(i),a=new Array(n.length);for(let u=0;u<n.length;u++){const o=n[u],f=i[o];typeof f!="object"||f===null?a[o]=f:f.constructor!==Object&&(s=t.get(f.constructor))?a[o]=s(f,l):ArrayBuffer.isView(f)?a[o]=F(f):a[o]=l(f)}return a}function c(i){if(typeof i!="object"||i===null)return i;if(Array.isArray(i))return r(i,c);if(i.constructor!==Object&&(s=t.get(i.constructor)))return s(i,c);const l={};for(const n in i){if(Object.hasOwnProperty.call(i,n)===!1)continue;const a=i[n];typeof a!="object"||a===null?l[n]=a:a.constructor!==Object&&(s=t.get(a.constructor))?l[n]=s(a,c):ArrayBuffer.isView(a)?l[n]=F(a):l[n]=c(a)}return l}function h(i){if(typeof i!="object"||i===null)return i;if(Array.isArray(i))return r(i,h);if(i.constructor!==Object&&(s=t.get(i.constructor)))return s(i,h);const l={};for(const n in i){const a=i[n];typeof a!="object"||a===null?l[n]=a:a.constructor!==Object&&(s=t.get(a.constructor))?l[n]=s(a,h):ArrayBuffer.isView(a)?l[n]=F(a):l[n]=h(a)}return l}}function ce(e){const t=[],s=[],r=new Map;if(r.set(Date,n=>new Date(n)),r.set(Map,(n,a)=>new Map(h(Array.from(n),a))),r.set(Set,(n,a)=>new Set(h(Array.from(n),a))),e.constructorHandlers)for(const n of e.constructorHandlers)r.set(n[0],n[1]);let c=null;return e.proto?l:i;function h(n,a){const u=Object.keys(n),o=new Array(u.length);for(let f=0;f<u.length;f++){const S=u[f],m=n[S];if(typeof m!="object"||m===null)o[S]=m;else if(m.constructor!==Object&&(c=r.get(m.constructor)))o[S]=c(m,a);else if(ArrayBuffer.isView(m))o[S]=F(m);else{const I=t.indexOf(m);I!==-1?o[S]=s[I]:o[S]=a(m)}}return o}function i(n){if(typeof n!="object"||n===null)return n;if(Array.isArray(n))return h(n,i);if(n.constructor!==Object&&(c=r.get(n.constructor)))return c(n,i);const a={};t.push(n),s.push(a);for(const u in n){if(Object.hasOwnProperty.call(n,u)===!1)continue;const o=n[u];if(typeof o!="object"||o===null)a[u]=o;else if(o.constructor!==Object&&(c=r.get(o.constructor)))a[u]=c(o,i);else if(ArrayBuffer.isView(o))a[u]=F(o);else{const f=t.indexOf(o);f!==-1?a[u]=s[f]:a[u]=i(o)}}return t.pop(),s.pop(),a}function l(n){if(typeof n!="object"||n===null)return n;if(Array.isArray(n))return h(n,l);if(n.constructor!==Object&&(c=r.get(n.constructor)))return c(n,l);const a={};t.push(n),s.push(a);for(const u in n){const o=n[u];if(typeof o!="object"||o===null)a[u]=o;else if(o.constructor!==Object&&(c=r.get(o.constructor)))a[u]=c(o,l);else if(ArrayBuffer.isView(o))a[u]=F(o);else{const f=t.indexOf(o);f!==-1?a[u]=s[f]:a[u]=l(o)}}return t.pop(),s.pop(),a}}const ae=Z(ie),A=ae();function oe(e,t){if(e===t)return!0;const s=Object.keys(e),r=Object.keys(t);if(s.length!==r.length)return!1;let c=0;for(;c<s.length;){const h=s[c],i=e[h];if(i===void 0&&!t.hasOwnProperty(h)||i!==t[h])return!1;c++}return!0}function le(e,t){if(e===t)return!0;if(e.length!==t.length)return!1;for(let s=0,r=e.length;s<r;s++)if(e[s]!==t[s])return!1;return!0}function he(e,t){if(e&&t){if(e.constructor===Object&&t.constructor===Object)return oe(e,t);if(Array.isArray(e)&&Array.isArray(t))return le(e,t)}return e===t}function P(e){const t=Object.getOwnPropertyNames(e);for(const s of t){const r=e[s];r&&typeof r=="object"&&P(r)}return Object.freeze(e)}const M=P({[p]:["licenseTypes","licenses","imageCategories","imageExtensions","aspectRatios","sizes","imageProviders"],[y]:["licenseTypes","licenses","audioCategories","audioExtensions","lengths","audioProviders"],[B]:[],[V]:[],[g]:["licenseTypes","licenses"]}),ue=P({[g]:[],[p]:["imageCategories","imageExtensions","aspectRatios","sizes","imageProviders"],[y]:["audioCategories","audioExtensions","lengths","audioProviders"],[B]:[],[V]:[]}),fe=P({licenses:[...ee],licenseTypes:["commercial","modification"],audioCategories:["audiobook","music","news","podcast","pronunciation","sound_effect"],imageCategories:["photograph","illustration","digitized_artwork"],audioExtensions:["flac","mid","mp3","oga","ogg","opus","wav","webm"],imageExtensions:["jpg","png","gif","svg"],aspectRatios:["tall","wide","square"],lengths:["shortest","short","medium","long"],sizes:["small","medium","large"],audioProviders:[],imageProviders:[]}),de=()=>Object.entries(fe).reduce((e,[t,s])=>({...e,[t]:s.map(r=>({code:r,name:`filters.${t}.${r}`,checked:!1}))}),{}),R=P(de()),O={licenses:"license",licenseTypes:"license_type",audioCategories:"category",imageCategories:"category",audioExtensions:"extension",imageExtensions:"extension",lengths:"length",aspectRatios:"aspect_ratio",sizes:"size",audioProviders:"source",imageProviders:"source"},z=e=>k.includes(e)?[...M[e]]:[],ge=e=>{const t=e.filter(s=>s.checked).map(s=>s.code).join(",");return t===w?"true":t},me=(e,t=g,s=!0)=>z(t).reduce((c,h)=>{const i=O[h],l=ge(e[h]);return(l||!s)&&(c[i]=l),c},{}),pe=e=>{const t=new RegExp(`/search/(${G.join("|")})`),s=e.match(t);return s===null?g:s[1]},Se=(e,t)=>(e!==""&&e.split(",").forEach(r=>{const c=t.findIndex(h=>h.code===r);c>-1&&(t[c]={...t[c],checked:!0})}),t),ye=({query:e,searchType:t="image",defaultFilters:s})=>{const r=A(s),c=z(t),h=["audioProviders","imageProviders","audioExtensions","imageExtensions","audioCategories","imageCategories"];return c.forEach(i=>{if(h.includes(i)){if(i.startsWith(t)){const l=e[O[i]];l&&(r[i]=Se(l,r[i]))}}else{const l=O[i];e[l]&&(l===w&&e[l].length>0?r[i][0].checked=!0:e[l].split(",").forEach(a=>{const u=r[i].findIndex(o=>o.code===a);u>=0&&(r[i][u].checked=!0)}))}}),r},$e=(e,t)=>(delete e.q,delete t.q,he(e,t)),Fe=e=>{const t={};return Object.keys(e).forEach(s=>{const r=te(e[s]);r&&(t[s]=r)}),t},E=e=>k.includes(e);function H(e){return e==="frontend"?{}:Q().isOn("fetch_sensitive")?{[w]:"true"}:{}}function C(e,t,s,r){const c=s.trim();return E(e)?{q:c,...me(t,e),...H(r)}:{q:c}}function Pe(e){const{collection:t,...s}=e,r={collection:t,unstable__collection:t,...s,...H("API")};return"tag"in r&&(r.unstable__tag=r.tag),r}const x=v("search",{state:()=>({searchType:g,searchTerm:"",strategy:"default",collectionParams:null,backToSearchPath:"",localSearchTerm:"",recentSearches:b("recent-searches",[]),filters:A(R),savedSearchCount:U().public.savedSearchCount}),hydrate(e){const t=b("recent-searches",[]);e.searchTerm&&(t.value=[e.searchTerm,...t.value.filter(s=>s!==e.searchTerm)].slice(0,e.savedSearchCount)),e.recentSearches=t.value},getters:{filterCategories(e){return Object.keys(e.filters)},apiSearchQueryParams(e){return C(e.searchType,e.filters,e.searchTerm,"API")},appliedFilterCount(e){return M[e.searchType].reduce((s,r)=>s+e.filters[r].filter(c=>c.checked).length,0)},searchFilters(e){return M[e.searchType].reduce((t,s)=>(t[s]=this.filters[s],t),{})},isAnyFilterApplied(){return Object.entries(this.searchFilters).some(([,t])=>t.some(s=>s.checked))},searchTypeIsSupported(e){return E(e.searchType)},collectionValue(){if(this.collectionParams===null)return null;switch(this.collectionParams.collection){case"creator":return`${this.collectionParams.source}/${this.collectionParams.creator}`;case"source":return this.collectionParams.source;case"tag":return this.collectionParams.tag}}},actions:{getApiRequestQuery(e){return this.collectionParams===null?C(e,this.filters,this.searchTerm,"API"):Pe(this.collectionParams)},setBackToSearchPath(e){this.backToSearchPath=e},updateSearchPath({type:e,searchTerm:t}={}){return e&&this.setSearchType(e),t&&this.setSearchTerm(t),this.getSearchPath()},getSearchPath({type:e,query:t}={}){const s=e??this.searchType,r=t??C(s,this.filters,this.searchTerm,"frontend");return T().$localePath({path:J(s),query:r})},getCollectionPath({type:e,collectionParams:t}){const s=`/${e}/collection`,{collection:r,...c}=t;return T().$localePath({path:s,query:c})},setSearchType(e){if(!Q().isOn("additional_search_types")&&N(e))throw new Error(`Please enable the 'additional_search_types' flag to use the ${e}`);this.searchType=e,this.clearOtherMediaTypeFilters(e)},setSearchTerm(e){const t=e?e.trim():"";this.searchTerm!==t&&(this.searchTerm=t,this.localSearchTerm=t,this.collectionParams=null,this.strategy="default",this.addRecentSearch(t))},setCollectionState(e,t){this.collectionParams=e,this.strategy=e.collection,this.setSearchType(t),this.clearFilters(),$().clearMedia()},setSearchStateFromUrl({path:e,urlQuery:t}){const s=Fe(t);if(this.strategy="default",this.collectionParams=null,$().clearMedia(),this.setSearchTerm(s.q),this.searchType=pe(e),!E(this.searchType))return;const c=ye({query:s,searchType:this.searchType,defaultFilters:this.getBaseFiltersWithProviders()});this.replaceFilters(c)},updateRecentSearches(e){b("recent-searches",e).value=e,this.recentSearches=e},addRecentSearch(e){const t=[e,...this.recentSearches.filter(s=>s!==e)].slice(0,this.savedSearchCount);this.updateRecentSearches(t)},clearRecentSearches(e){const t=e?this.recentSearches.filter(s=>s!==e):[];this.updateRecentSearches(t)},getBaseFiltersWithProviders(){const e=t=>this.filters[`${t}Providers`].map(s=>({...s,checked:!1}));return{...A(R),audioProviders:e(y),imageProviders:e(p)}},async initProviderFilters(){const e=X();for(const t of d)this.updateProviderFilters({mediaType:t,providers:e.providers[t]})},updateProviderFilters({mediaType:e,providers:t}){const s=`${e}Providers`,r=this.filters[s]?[...this.filters[s]]:[];this.filters[s]=t.map(c=>{const h=r.findIndex(l=>l.code===c.source_name),i=h>=0?r[h].checked:!1;return{code:c.source_name,name:c.display_name,checked:i}})},toggleFilter({filterType:e,codeIdx:t,code:s}){return this.setFilter({filterType:e,codeIdx:t,code:s,toggle:!0})},setFilter({filterType:e,codeIdx:t,code:s,value:r=!0,toggle:c=!1}){if(typeof t>"u"&&typeof s>"u")throw new Error(`Cannot update filter of type ${e}. Use code or codeIdx parameter`);const h=this.filters[e],i=t??h.findIndex(l=>l.code===s);return this.filters[e][i].checked=c?!this.filters[e][i].checked:r,this.filters[e][i].checked},clearFilters(){for(const e of this.filterCategories)for(const t of this.filters[e])t.checked=!1},clearOtherMediaTypeFilters(e){const s=k.filter(r=>r!==e).reduce((r,c)=>[...r,...ue[c]],[]);this.filterCategories.forEach(r=>{s.includes(r)&&(this.filters[r]=this.filters[r].map(c=>({...c,checked:!1})))})},replaceFilters(e){this.filterCategories.forEach(t=>{this.filters[t]=e[t]})},isFilterDisabled(e,t){if(!["licenseTypes","licenses"].includes(t))return!1;if(e.code==="commercial"||e.code==="modification"){const s={commercial:"nc",modification:"nd"}[e.code];return this.filters.licenses.some(r=>r.code.includes(s)&&r.checked)}else{const s=[];return e.code.includes("nc")&&s.push("commercial"),e.code.includes("nd")&&s.push("modification"),this.filters.licenseTypes.some(r=>s.includes(r.code)&&r.checked)}}}}),Ee=v("related-media",{state:()=>({mainMediaId:null,fetchState:{isFetching:!1,hasStarted:!1,fetchingError:null},media:[]}),getters:{getItemById:e=>t=>e.media.find(s=>s.id===t)},actions:{_endFetching(e){this.fetchState.fetchingError=e||null,this.fetchState.hasStarted=!0,this.fetchState.isFetching=!1},_startFetching(){this.fetchState.isFetching=!0,this.fetchState.hasStarted=!0,this.fetchState.fetchingError=null},_resetFetching(){this.fetchState.isFetching=!1,this.fetchState.hasStarted=!1,this.fetchState.fetchingError=null},async fetchMedia(e,t){if(this.mainMediaId===t&&this.media.length>0)return this.media;this._resetFetching(),this.mainMediaId=t,this._startFetching(),this.media=[];const s=D();try{return this.media=await s.getRelatedMedia(e,t),this._endFetching(),this.media}catch(r){const{$processFetchingError:c}=T(),h=c(r,e,"related",{id:t});return this._endFetching(h),null}}}}),q=P({count:0,page:0,pageCount:0,items:{}}),$=v("media",{state:()=>({results:{[y]:{...q},[p]:{...q}},mediaFetchState:{[y]:{isFetching:!1,hasStarted:!1,isFinished:!1,fetchingError:null},[p]:{isFetching:!1,hasStarted:!1,isFinished:!1,fetchingError:null}},currentPage:0}),getters:{_searchType(){const e=x().searchType;return N(e)?g:e},getItemById:e=>(t,s)=>{const r=e.results[t].items[s];return r||Ee().getItemById(s)},resultItems(e){return d.reduce((t,s)=>({...t,[s]:Object.values(e.results[s].items)}),{})},resultCountsPerMediaType(){return d.map(e=>[e,this.results[e].count])},resultCount(e){return(this._searchType===g||!E(this._searchType)?d:[this._searchType]).reduce((s,r)=>s+e.results[r].count,0)},fetchState(){if(this._searchType===g){const e=s=>d.some(r=>this.mediaFetchState[r][s]),t=()=>{const s=Te(this.mediaFetchState);if(!s.length)return null;const r=_e(s);if(r!==null)return r.searchType=g,r;const c=be(s);if(c)return c;const h=s.filter(i=>i.code!==_);return h.length?h[0]:null};return{isFetching:e("isFetching"),fetchingError:t(),hasStarted:e("hasStarted"),isFinished:d.every(s=>this.mediaFetchState[s].isFinished)}}else return E(this._searchType)?this.mediaFetchState[this._searchType]:{isFetching:!1,fetchingError:null,hasStarted:!1,isFinished:!1}},allMedia(e){var a,u;const t=this.resultItems,s=(a=t[p][0])==null?void 0:a.id;let r;if(typeof s=="string")r=j(s);else{let o="string";for(const f of d.slice(1))if(typeof((u=t[f][0])==null?void 0:u.id)=="string"){o=t[f][0].id;break}r=j(o)}const c=K(r),h=(o,f)=>Math.floor(c()*(f-o+1))+o,[i]=d.map(o=>[o,e.results[o].count]).sort(([,o],[,f])=>f-o)[0],l=t[i];let n=1;for(const o of d.filter(f=>f!==i))for(const f of t[o])if(l.splice(n,0,f),n=h(n+1,n+6),n>l.length)break;return l},_fetchableMediaTypes(){return(this._searchType!==g?[this._searchType]:[p,y]).filter(e=>!this.mediaFetchState[e].fetchingError&&!this.mediaFetchState[e].isFetching&&!this.mediaFetchState[e].isFinished)},canLoadMore(){return this.fetchState.hasStarted&&!this.fetchState.fetchingError&&!this.fetchState.isFinished&&this.resultCount>0}},actions:{_startFetching(e){this.mediaFetchState[e].isFetching=!0,this.mediaFetchState[e].hasStarted=!0,this.mediaFetchState[e].isFinished=!1,this.mediaFetchState[e].fetchingError=null},_endFetching(e,t){this.mediaFetchState[e].fetchingError=t||null,this.mediaFetchState[e].hasStarted=!0,this.mediaFetchState[e].isFetching=!1,t&&!re(t)&&(this.mediaFetchState[e].isFinished=!0)},_finishFetchingForQuery(e){this.mediaFetchState[e].isFinished=!0,this.mediaFetchState[e].hasStarted=!0,this.mediaFetchState[e].isFetching=!1},_resetFetchState(){for(const e of d)this.mediaFetchState[e].isFetching=!1,this.mediaFetchState[e].hasStarted=!1,this.mediaFetchState[e].isFinished=!1,this.mediaFetchState[e].fetchingError=null},_updateFetchState(e,t,s){switch(t){case"reset":{this._resetFetchState();break}case"start":{this._startFetching(e);break}case"end":{this._endFetching(e,s);break}case"finish":{this._finishFetchingForQuery(e);break}}},setMedia(e){const{mediaType:t,media:s,mediaCount:r,page:c,pageCount:h,shouldPersistMedia:i}=e;let l;i?l={...this.results[t].items,...s}:l=s;const n=c||1;this.results[t].items=l,this.results[t].count=r||0,this.results[t].page=r===0?0:n,this.results[t].pageCount=h,n>=h&&this._updateFetchState(t,"finish")},resetMedia(e){this.results[e].items={},this.results[e].count=0,this.results[e].page=0,this.results[e].pageCount=0},async fetchMedia(e={}){const t=this._searchType,s=!!e.shouldPersistMedia,r=this._fetchableMediaTypes;return await Promise.allSettled(r.map(c=>this.fetchSingleMediaType({mediaType:c,shouldPersistMedia:s}))),this.currentPage=t===g?this.currentPage+1:this.results[t].page,t===g?this.allMedia:this.resultItems[t]},clearMedia(){d.forEach(e=>{this.resetMedia(e),this._resetFetchState()}),this.currentPage=0},async fetchSingleMediaType({mediaType:e,shouldPersistMedia:t}){const r=x().getApiRequestQuery(e);let c=this.results[e].page+1;t&&(r.page=`${c}`),this._updateFetchState(e,"start");const{$sendCustomEvent:h,$processFetchingError:i}=T(),l=D();try{const{eventPayload:n,data:a}=await l.search(e,r);n&&h("SEARCH_RESPONSE_TIME",n);const u=a.result_count;let o;return u||(c=1,o={message:`No results found for ${r.q}`,code:_,requestKind:"search",searchType:e,details:{searchTerm:r.q??""}}),this._updateFetchState(e,"end",o),this.setMedia({mediaType:e,media:a.results,mediaCount:u,pageCount:a.page_count,shouldPersistMedia:t,page:c}),u}catch(n){const a=i(n,e,"search",{searchTerm:r.q??""});return this._updateFetchState(e,"end",a),null}},setMediaProperties(e,t,s){const r=this.getItemById(e,t);r?Object.assign(r,s):W(`Attempted to update media item ${e} ${t} but could not find it.`)}}}),Te=e=>d.map(t=>e[t].fetchingError).filter(t=>t!==null),_e=e=>e.find(({statusCode:t})=>t===429)??null,be=e=>e.length===d.length&&e.every(({code:t})=>t===_)?{...e[0],searchType:g}:null;export{x as a,$e as b,re as c,Ee as d,oe as e,R as f,qe as h,E as i,M as m,Fe as q,$ as u};
