{"version":3,"file":"O68K-DQz.js","sources":["../../src/composables/use-search.ts"],"sourcesContent":["import { navigateTo } from \"#imports\"\nimport { computed, watch } from \"vue\"\n\nimport { useSearchStore } from \"~/stores/search\"\nimport { useMediaStore } from \"~/stores/media\"\nimport { useI18nResultsCount } from \"~/composables/use-i18n-utilities\"\nimport { useMatchSearchRoutes } from \"~/composables/use-match-routes\"\nimport { useAnalytics } from \"~/composables/use-analytics\"\n\nexport const useSearch = (\n  sendCustomEvent: ReturnType<typeof useAnalytics>[\"sendCustomEvent\"]\n) => {\n  const mediaStore = useMediaStore()\n  const searchStore = useSearchStore()\n\n  const { matches: isSearchRoute } = useMatchSearchRoutes()\n\n  const storeSearchTerm = computed(() => searchStore.searchTerm)\n\n  /**\n   * To update the local search term when the route changes, when, for example,\n   * the user clicks the back button, we need to watch the store search term.\n   */\n  watch(storeSearchTerm, (newSearchTerm) => {\n    searchTerm.value = newSearchTerm\n  })\n\n  /**\n   * Search term has a getter and setter to be used as a v-model.\n   * To prevent sending unnecessary requests, we also keep track of whether\n   * the search term was changed.\n   */\n  const searchTerm = computed({\n    get: () => searchStore.localSearchTerm,\n    set: (value: string) => {\n      searchStore.localSearchTerm = value\n    },\n  })\n\n  const searchTermChanged = computed(\n    () => searchStore.searchTerm !== searchTerm.value\n  )\n\n  /**\n   * Called when the 'search' button is clicked in the header.\n   *\n   * No op if the search term is blank.\n   * If the search term hasn't changed from the store version, we do nothing on\n   * a search route. On other routes, we set the search type to 'All content' and\n   * reset the media.\n   *\n   * Then, we update the search term, and update the path.\n   *\n   * Updating the path causes the `search.vue` page's route watcher\n   * to run and fetch new media.\n   */\n  const updateSearchState = () => {\n    if (searchTerm.value === \"\") {\n      return\n    }\n    if (!searchTermChanged.value && isSearchRoute.value) {\n      return\n    }\n\n    sendCustomEvent(\"SUBMIT_SEARCH\", {\n      searchType: searchStore.searchType,\n      query: searchTerm.value,\n    })\n\n    const searchPath = searchStore.updateSearchPath({\n      searchTerm: searchTerm.value,\n    })\n    return navigateTo(searchPath)\n  }\n\n  const isFetching = computed(() => mediaStore.fetchState.isFetching)\n  const resultsCount = computed(() => mediaStore.resultCount)\n\n  const { getI18nCount, getLoading } = useI18nResultsCount()\n  /**\n   * Additional text at the end of the search bar.\n   * Shows the loading state or result count.\n   */\n  const searchStatus = computed(() => {\n    if (searchStore.searchTerm === \"\") {\n      return \"\"\n    }\n    if (isFetching.value) {\n      return getLoading()\n    }\n    return getI18nCount(resultsCount.value)\n  })\n\n  return {\n    updateSearchState,\n    searchTerm,\n    searchStatus,\n  }\n}\n"],"names":["useSearch","sendCustomEvent","mediaStore","useMediaStore","searchStore","useSearchStore","isSearchRoute","useMatchSearchRoutes","storeSearchTerm","computed","watch","newSearchTerm","searchTerm","value","searchTermChanged","updateSearchState","searchPath","navigateTo","isFetching","resultsCount","getI18nCount","getLoading","useI18nResultsCount","searchStatus"],"mappings":"ugBASa,MAAAA,EACXC,GACG,CACH,MAAMC,EAAaC,EAAc,EAC3BC,EAAcC,EAAe,EAE7B,CAAE,QAASC,CAAc,EAAIC,EAAqB,EAElDC,EAAkBC,EAAS,IAAML,EAAY,UAAU,EAMvDM,EAAAF,EAAkBG,GAAkB,CACxCC,EAAW,MAAQD,CAAA,CACpB,EAOD,MAAMC,EAAaH,EAAS,CAC1B,IAAK,IAAML,EAAY,gBACvB,IAAMS,GAAkB,CACtBT,EAAY,gBAAkBS,CAAA,CAChC,CACD,EAEKC,EAAoBL,EACxB,IAAML,EAAY,aAAeQ,EAAW,KAC9C,EAeMG,EAAoB,IAAM,CAI9B,GAHIH,EAAW,QAAU,IAGrB,CAACE,EAAkB,OAASR,EAAc,MAC5C,OAGFL,EAAgB,gBAAiB,CAC/B,WAAYG,EAAY,WACxB,MAAOQ,EAAW,KAAA,CACnB,EAEK,MAAAI,EAAaZ,EAAY,iBAAiB,CAC9C,WAAYQ,EAAW,KAAA,CACxB,EACD,OAAOK,EAAWD,CAAU,CAC9B,EAEME,EAAaT,EAAS,IAAMP,EAAW,WAAW,UAAU,EAC5DiB,EAAeV,EAAS,IAAMP,EAAW,WAAW,EAEpD,CAAE,aAAAkB,EAAc,WAAAC,CAAW,EAAIC,EAAoB,EAKnDC,EAAed,EAAS,IACxBL,EAAY,aAAe,GACtB,GAELc,EAAW,MACNG,EAAW,EAEbD,EAAaD,EAAa,KAAK,CACvC,EAEM,MAAA,CACL,kBAAAJ,EACA,WAAAH,EACA,aAAAW,CACF,CACF"}